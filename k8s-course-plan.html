<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2020-08-02 Sun 23:20 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>K8s course</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Byron Wang" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/styles/readtheorg/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">K8s course</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgdd8b5aa">1. 课程目的</a>
<ul>
<li><a href="#org1047460">1.1. 进阶要求</a></li>
</ul>
</li>
<li><a href="#orgcc59c7a">2. 课程安排</a></li>
<li><a href="#org1715835">3. 了解 kubernetes 之前<span class="timestamp-wrapper"><span class="timestamp">&lt;2019-12-06 Fri&gt;</span></span></a>
<ul>
<li><a href="#org01a1d6e">3.1. 课程大纲</a></li>
<li><a href="#orgaee8d8a">3.2. Cgroup、Container 与 OCI</a>
<ul>
<li><a href="#org2917e29">3.2.1. cgroups &amp; namespaces &amp; chroot &amp; systemd</a></li>
<li><a href="#org7162174">3.2.2. Container 的前世今生</a></li>
<li><a href="#org289cff6">3.2.3. OCI</a></li>
<li><a href="#orga828e91">3.2.4. docker 中容器的创建</a></li>
</ul>
</li>
<li><a href="#org1dfdf56">3.3. Docker 与虚拟机</a>
<ul>
<li><a href="#org0f7de7d">3.3.1. 主流虚拟机的原理</a></li>
<li><a href="#orge7dd351">3.3.2. 容器与虚拟机</a></li>
</ul>
</li>
<li><a href="#orgb68745c">3.4. kubernetes 是什么</a>
<ul>
<li><a href="#org6d55f7c">3.4.1. 我们为什么需要编排</a></li>
<li><a href="#orgf0aa278">3.4.2. kubernetes 的历史</a></li>
</ul>
</li>
<li><a href="#org8bd0451">3.5. kubernetes 生态与社区</a>
<ul>
<li><a href="#org5479822">3.5.1. kubernetes 生态中的明星</a></li>
<li><a href="#orga9c002b">3.5.2. kubernetes 社区</a></li>
</ul>
</li>
<li><a href="#orgde1acf8">3.6. 课后作业</a></li>
</ul>
</li>
<li><a href="#orgd45619b">4. Containers 与 Pods<span class="timestamp-wrapper"><span class="timestamp">&lt;2019-12-13 Fri&gt;</span></span></a>
<ul>
<li><a href="#org7adca8e">4.1. 课程大纲</a></li>
<li><a href="#org837665e">4.2. CRI</a>
<ul>
<li><a href="#orge9db26f">4.2.1. CRI 的意义</a></li>
<li><a href="#org649327b">4.2.2. CRI 的接口</a></li>
</ul>
</li>
<li><a href="#org57449e0">4.3. 容器与 Pod</a>
<ul>
<li><a href="#org7abe09d">4.3.1. Pod 是什么</a></li>
<li><a href="#org8354baa">4.3.2. Pod 里面有什么</a></li>
<li><a href="#orgfec00d0">4.3.3. Pod 实现原理</a></li>
<li><a href="#orgdf70198">4.3.4. init containers</a></li>
<li><a href="#orgf5c1306">4.3.5. POD 的生命周期</a></li>
<li><a href="#orgcad4554">4.3.6. Pod 的回收</a></li>
<li><a href="#org9fede64">4.3.7. multi Pod 的实际场景</a></li>
</ul>
</li>
<li><a href="#org81ae388">4.4. 课后作业</a></li>
</ul>
</li>
<li><a href="#org0f41cc4">5. Yaml 与 kubectl <span class="timestamp-wrapper"><span class="timestamp">&lt;2019-12-20 Fri&gt;</span></span></a>
<ul>
<li><a href="#org5996e88">5.1. 课程大纲</a></li>
<li><a href="#org7b4e0e3">5.2. kubernetes yaml</a>
<ul>
<li><a href="#org73fabe6">5.2.1. annotation</a></li>
<li><a href="#org49f48a9">5.2.2. label &amp;&amp; selector</a></li>
<li><a href="#org2de37eb">5.2.3. namespace</a></li>
<li><a href="#orgeb7f9a5">5.2.4. apiVersion</a></li>
<li><a href="#orgaca9857">5.2.5. toleration &amp;&amp; taint</a></li>
</ul>
</li>
<li><a href="#orga8a45c1">5.3. kubectl</a>
<ul>
<li><a href="#org18a1844">5.3.1. kubectl get</a></li>
<li><a href="#org0bd7ba8">5.3.2. kubectl apply</a></li>
<li><a href="#org2e20041">5.3.3. kubectl logs</a></li>
<li><a href="#org734743a">5.3.4. kubectl exec</a></li>
<li><a href="#orgbb6d108">5.3.5. kubectl edit</a></li>
</ul>
</li>
<li><a href="#org11d4e80">5.4. 作业</a></li>
</ul>
</li>
<li><a href="#org468539c">6. Pod controllers <span class="timestamp-wrapper"><span class="timestamp">&lt;2019-12-27 Fri&gt;</span></span></a>
<ul>
<li><a href="#orgfdcd56f">6.1. 课程大纲</a></li>
<li><a href="#orgab8cd88">6.2. Replicaset (rs)</a></li>
<li><a href="#org105e399">6.3. ReplicationController (rc)</a></li>
<li><a href="#org10e263a">6.4. Deployments (deploy)</a>
<ul>
<li><a href="#org046219a">6.4.1. 更新一个 deploy</a></li>
<li><a href="#orge06392a">6.4.2. 滚动发布</a></li>
<li><a href="#orga11771a">6.4.3. 扩展</a></li>
<li><a href="#orgaea4e67">6.4.4. 自动扩展</a></li>
</ul>
</li>
<li><a href="#org9317faf">6.5. Jobs</a>
<ul>
<li><a href="#orga16bb0c">6.5.1. 不同的 job</a></li>
</ul>
</li>
<li><a href="#org19c0fa7">6.6. CronJob</a>
<ul>
<li><a href="#orgdd917f5">6.6.1. 什么是 crontab</a></li>
</ul>
</li>
<li><a href="#org7dceb4a">6.7. DaemonSet (ds)</a>
<ul>
<li><a href="#org155f27c">6.7.1. 如果 ds 遇到 taint 如何处理？</a></li>
</ul>
</li>
<li><a href="#orgdc037a0">6.8. 课后作业</a></li>
</ul>
</li>
<li><a href="#org5a51f15">7. 有状态、无状态与 Cloud native <span class="timestamp-wrapper"><span class="timestamp">&lt;2020-01-03 Fri&gt;</span></span></a>
<ul>
<li><a href="#org9a53d94">7.1. 课程大纲</a></li>
<li><a href="#org1ce35c2">7.2. 无中生有</a>
<ul>
<li><a href="#orgecf8463">7.2.1. 什么是幂等性</a></li>
<li><a href="#org0066e38">7.2.2. 无状态服务与有状态服务</a></li>
</ul>
</li>
<li><a href="#org55173c7">7.3. StatefulSet (sts)</a>
<ul>
<li><a href="#orgef87afd">7.3.1. 特点</a></li>
<li><a href="#org8305a86">7.3.2. 场景</a></li>
<li><a href="#orgb250e19">7.3.3. example</a></li>
</ul>
</li>
<li><a href="#org2114793">7.4. Cloud-Native</a>
<ul>
<li><a href="#org78c9124">7.4.1. DevOps</a></li>
<li><a href="#org34b011a">7.4.2. Microservices</a></li>
<li><a href="#org784c1be">7.4.3. Container</a></li>
</ul>
</li>
<li><a href="#orgc1f6629">7.5. 课后作业</a></li>
</ul>
</li>
<li><a href="#orgf110da8">8. Service Loadbalanceing and Networking <span class="timestamp-wrapper"><span class="timestamp">&lt;2020-01-10 Fri&gt; </span></span> <span class="timestamp-wrapper"><span class="timestamp">&lt;2020-01-17 Fri&gt;</span></span></a>
<ul>
<li><a href="#org8cc255c">8.1. 课程大纲</a></li>
<li><a href="#org471f04c">8.2. 为什么在 kubernetes 中需要 service</a>
<ul>
<li><a href="#orgb1a0e43">8.2.1. 今天不说小明的故事，今天来讲一个工具人的故事</a></li>
<li><a href="#org17ed366">8.2.2. Pod: 正是在下</a></li>
<li><a href="#org2e51ddb">8.2.3. 如何找到合适的工具人</a></li>
</ul>
</li>
<li><a href="#orge061d9c">8.3. Service 如何找到 pod 的</a>
<ul>
<li><a href="#org2a67a01">8.3.1. endpoint 与 Endpoint slices</a></li>
</ul>
</li>
<li><a href="#org931be80">8.4. Service 的几种类型</a>
<ul>
<li><a href="#orgb924a11">8.4.1. ClusterIP</a></li>
<li><a href="#orgcd43639">8.4.2. NodePort</a></li>
<li><a href="#org57eb43d">8.4.3. LoadBalancer</a></li>
<li><a href="#orga83e486">8.4.4. ExternalName</a></li>
<li><a href="#orgbf14d40">8.4.5. Headless</a></li>
</ul>
</li>
<li><a href="#org7606c37">8.5. Ingress 与 Ingress controller</a></li>
<li><a href="#orgd4d7125">8.6. Network policies</a></li>
<li><a href="#org0025b7b">8.7. IPv4/IPv6</a></li>
<li><a href="#org740fb37">8.8. 课后作业</a></li>
</ul>
</li>
<li><a href="#org49a3706">9. Storage <span class="timestamp-wrapper"><span class="timestamp">&lt;2020-03-23 Mon&gt;</span></span></a>
<ul>
<li><a href="#orgd8d4e07">9.1. 课程大纲</a></li>
<li><a href="#org50c25e1">9.2. 从删库跑路到数据恢复</a>
<ul>
<li><a href="#orgb4328ac">9.2.1. 数据的保存</a></li>
<li><a href="#orgf4f2959">9.2.2. 给容器用的存储方案</a></li>
</ul>
</li>
<li><a href="#orgb660894">9.3. Volumes</a>
<ul>
<li><a href="#org7586e9d">9.3.1. kubernetes 支持的存储卷</a></li>
<li><a href="#org60ef2f3">9.3.2. CSI</a></li>
</ul>
</li>
<li><a href="#org19cd78f">9.4. PV PVC and Storage Class</a>
<ul>
<li><a href="#orge6cf283">9.4.1. PV PVC 的概念</a></li>
<li><a href="#org34ec5f7">9.4.2. 创建一个 PV 与 PVC</a></li>
<li><a href="#org6c0fff8">9.4.3. Storage Class</a></li>
<li><a href="#org1ebdf4f">9.4.4. 创建一个 Storage Class</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org6953374">10. 最佳实践</a>
<ul>
<li><a href="#org87263b7">10.1. 如何最快的准备一个单节点 k8s 集群</a>
<ul>
<li><a href="#org7677d51">10.1.1. 前言</a></li>
<li><a href="#orgb948036">10.1.2. 使用 microk8s 进行安装</a></li>
</ul>
</li>
<li><a href="#org370f3b9">10.2. 部署一个 wordpress</a>
<ul>
<li><a href="#org079a1c7">10.2.1. 创建 mysql 的相关资源</a></li>
<li><a href="#org5864f55">10.2.2. 创建 wordpress 的相关资源</a></li>
<li><a href="#org471b45a">10.2.3. 注意事项</a></li>
</ul>
</li>
<li><a href="#orgf6f0786">10.3. 创建一个最小的 Operator</a>
<ul>
<li><a href="#org8abc4f2">10.3.1. CustomResource 与 Operator</a></li>
<li><a href="#org3e69f4d">10.3.2. 如何实现一个自定义的资源</a></li>
<li><a href="#org197ee60">10.3.3. 在集群中创建一个 milvus</a></li>
<li><a href="#orgd1a1a8c">10.3.4. 如何实现一个 Operator</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-orgdd8b5aa" class="outline-2">
<h2 id="orgdd8b5aa"><span class="section-number-2">1</span> 课程目的</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>可以独立安装 k8s 集群</li>
<li>可以简单运维 k8s 集群</li>
</ul>
</div>
<div id="outline-container-org1047460" class="outline-3">
<h3 id="org1047460"><span class="section-number-3">1.1</span> 进阶要求</h3>
<div class="outline-text-3" id="text-1-1">
<ul class="org-ul">
<li>可以实现一个 CNI/CRD/CCM</li>
<li>成为 k8s contributor</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgcc59c7a" class="outline-2">
<h2 id="orgcc59c7a"><span class="section-number-2">2</span> 课程安排</h2>
<div class="outline-text-2" id="text-2">
<p>
地点:会议室
时间:每周五下午 16:00-17:00
时间安排: 45min(讲解) + 15min(答疑)
作业形式: 问卷与实际操作
</p>
</div>
</div>
<div id="outline-container-org1715835" class="outline-2">
<h2 id="org1715835"><span class="section-number-2">3</span> 了解 kubernetes 之前<span class="timestamp-wrapper"><span class="timestamp">&lt;2019-12-06 Fri&gt;</span></span></h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org01a1d6e" class="outline-3">
<h3 id="org01a1d6e"><span class="section-number-3">3.1</span> 课程大纲</h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li>操作系统基础</li>
<li>简介 docker 与 container</li>
<li>docker 与虚拟机的区别</li>
<li>认识什么是 kubernetes</li>
</ul>
</div>
</div>
<div id="outline-container-orgaee8d8a" class="outline-3">
<h3 id="orgaee8d8a"><span class="section-number-3">3.2</span> Cgroup、Container 与 OCI</h3>
<div class="outline-text-3" id="text-3-2">
</div>
<div id="outline-container-org2917e29" class="outline-4">
<h4 id="org2917e29"><span class="section-number-4">3.2.1</span> cgroups &amp; namespaces &amp; chroot &amp; systemd</h4>
<div class="outline-text-4" id="text-3-2-1">
<p>
cgroups<sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup> 用来控制一个每个服务的 CPU、mem、block I/O、device、net(tc)
</p>

<p>
namespaces<sup><a id="fnr.2" class="footref" href="#fn.2">2</a></sup> 用来做进程之间的隔离;UTS:主机 域名 IPC: 信号量 消息队列 共享内存 PID Network:设备 端口 网络栈 Mount: fs User:group user
</p>

<p>
chroot<sup><a id="fnr.3" class="footref" href="#fn.3">3</a></sup> 用于将一个进程及其子进程的根目录改变到文件系统中的一个新位置，让这些进程只能访问到该目录。这个功能的想法是为每个进程提供独立的磁盘空间
</p>

<p>
systemd<sup><a id="fnr.4" class="footref" href="#fn.4">4</a></sup> 用来启动守护进程,处理依赖关系
</p>
</div>
</div>
<div id="outline-container-org7162174" class="outline-4">
<h4 id="org7162174"><span class="section-number-4">3.2.2</span> Container 的前世今生</h4>
<div class="outline-text-4" id="text-3-2-2">
<ul class="org-ul">
<li>1979 — chroot 一切的开始</li>
<li>2000 — FreeBSD Jails 支持进程沙盒</li>
<li>2001 — Linux VServer  加入 security context</li>
<li>2004 — Solaris Containers 支持在 x86 和 SPARC 系统</li>
<li>2005 — OpenVZ      IPC 与设备的隔离</li>
<li>2006 — Process Containers kernel 2.6.24</li>
<li>2008 — LXC 第一个最完善的 Linux 容器管理器的实现方案;现在容器技术的雏形</li>
<li>2011 — Warde CloudFoundry 支持多个操作系统</li>
<li>2013 — LMCTFY Let Me Contain That For You  Google libcontainer 的前身</li>
<li>2013 — Docker images swarm 集大成者</li>
<li>2014 — Rocket CoreOS</li>
<li>2016 — Windows Containers Hyper-v</li>
<li>2017 — Pouch 富容器 Alibaba</li>
<li>2018 — Podman without of daemon</li>
<li>2018 — WIndows Containers Windows-base</li>
</ul>
</div>
</div>
<div id="outline-container-org289cff6" class="outline-4">
<h4 id="org289cff6"><span class="section-number-4">3.2.3</span> OCI</h4>
<div class="outline-text-4" id="text-3-2-3">
<p>
open container initiative<sup><a id="fnr.5" class="footref" href="#fn.5">5</a></sup>
</p>

<p>
Linux 基金会制定一个开放的工业化标准：容器运行时标准 （runtime spec）和 容器镜像标准（image spec）
</p>
<ul class="org-ul">
<li>image spec
文件系统
manifest 文件
index 文件</li>
<li>runtime spec
Container ID
PID
容器文件目录
容器创建
容器进程启动
容器暂停
容器暂停信号捕获
容器的生命周期: init creating created running stopped</li>
</ul>
</div>
</div>
<div id="outline-container-orga828e91" class="outline-4">
<h4 id="orga828e91"><span class="section-number-4">3.2.4</span> docker 中容器的创建</h4>
<div class="outline-text-4" id="text-3-2-4">

<div class="figure">
<p><img src="images/docker-runc.png" alt="docker-runc.png" />
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-org1dfdf56" class="outline-3">
<h3 id="org1dfdf56"><span class="section-number-3">3.3</span> Docker 与虚拟机</h3>
<div class="outline-text-3" id="text-3-3">
</div>
<div id="outline-container-org0f7de7d" class="outline-4">
<h4 id="org0f7de7d"><span class="section-number-4">3.3.1</span> 主流虚拟机的原理</h4>
<div class="outline-text-4" id="text-3-3-1">
</div>
<ol class="org-ol">
<li><a id="org361c102"></a>虚拟化技术<br />
<div class="outline-text-6" id="text-3-3-1-0-1">
<ul class="org-ul">
<li><p>
I型虚拟机
直接跑在裸机上，虚拟机软件模拟了完整的底层硬件;从 Cpu、时钟到外接设备
</p>

<p>
代表技术 VMwareESX  Hyper-V
</p></li>
<li><p>
II型虚拟机
运行在宿主机的操作系统之上,所有的操作都借助于宿主机的操作系统
</p>

<p>
代表技术: VMWare Workstation Hyper-V
</p></li>
</ul>
</div>
</li>
</ol>
</div>
<div id="outline-container-orge7dd351" class="outline-4">
<h4 id="orge7dd351"><span class="section-number-4">3.3.2</span> 容器与虚拟机</h4>
<div class="outline-text-4" id="text-3-3-2">
<p>
容器本身是虚拟化技术中的一种,作为最轻量级的虚拟化方案出现
</p>

<p>
但容器与虚拟机有本质上的区别
</p>

<p>
容器实际上是一个进程，而虚拟机则是一个完整的操作系统
</p>
</div>
</div>
</div>
<div id="outline-container-orgb68745c" class="outline-3">
<h3 id="orgb68745c"><span class="section-number-3">3.4</span> kubernetes 是什么</h3>
<div class="outline-text-3" id="text-3-4">
<p>
Production-Grade Container Scheduling and Management
这是 kubernetes github 仓库上对这个项目的描述
</p>
</div>
<div id="outline-container-org6d55f7c" class="outline-4">
<h4 id="org6d55f7c"><span class="section-number-4">3.4.1</span> 我们为什么需要编排</h4>
<div class="outline-text-4" id="text-3-4-1">
<p>
我们不妨了解一下小明的故事
</p>
</div>
<ol class="org-ol">
<li><a id="orgbf56e2c"></a>小明是一个开发者<br />
<div class="outline-text-6" id="text-3-4-1-0-1">
<p>
小明是一个开发者，这一天他想到了一个点子，他做了一个静态的网站，现在他想把网站上线。
于是他将代码拷贝到了租赁的服务器上运行，因为他有三个服务器，他不想每次都把改动传递很多次.
</p>

<p>
于是他想到了 Docker,他写了一个 Dockerfile 将网站打包成了 Docker 镜像，传到了镜像仓库，
他每次只要到三个服务器上更新容器的镜像就好了
</p>
</div>
</li>
<li><a id="org09258a8"></a>小明的网站提供其他的服务了<br />
<div class="outline-text-6" id="text-3-4-1-0-2">
<p>
小明的网站提供其他的服务了，小明的网站现在不仅仅是一个静态页面了，现在小明需要爬取一些数据，然后展示出来，
于是小明现在有两个服务：一个展示网站，一个用来爬取数据的服务。
小明遇到了问题:展示网站怎么连接到爬取数据的服务上，
</p>

<p>
于是小明将容器暴露了相应的端口用于内部服务的访问
</p>
</div>
</li>
<li><a id="org605458c"></a>小明的业务又扩展了<br />
<div class="outline-text-6" id="text-3-4-1-0-3">
<p>
小明的业务又扩展了，小明现在需要将爬取所有的数据存下来，放便做统计与查询。
</p>

<p>
小明将本地的目录挂载到了容器目录中，于是所有的数据就都保存在了本地。
</p>
</div>
</li>
<li><a id="org1357423"></a>小明的业务发展的特别迅速<br />
<div class="outline-text-6" id="text-3-4-1-0-4">
<p>
小明的业务发展的特别迅速，他有了几十倍的用户了，原有的三台服务器无法承受过大的压力，于是小明又多租了 17 台服务器，
这时小明遇到了几个问题：每一台机器存储的数据无法同步，而且现在每做一次改动都要改动到 20 台服务器上，小明觉得太麻烦了
</p>

<p>
于是小明将几台机器做成了 NFS 的服务器，然后所有的容器都挂载 NFS 的目录进行存储，又使用了一些批量处理工具。小明对自己很满意。
</p>
</div>
</li>
<li><a id="orgf7554fd"></a>小明的服务间歇性的被冲跨了<br />
<div class="outline-text-6" id="text-3-4-1-0-5">
<p>
小明的服务间歇性的被冲跨了，小明突然发现自己的服务在每天晚上凌晨左右会有几台被巨大的请求冲垮，小明现在无力负担起更多的服务器了，
小明只能运营商处购买负载均衡服务，试图将流量均匀的分配到不同的机器上。这样过了几天，小明发现有许多用户抱怨内容出现丢失了，
小明经过排查发现，由于 DNS 的原因之前的每个用户一般都被会到特定的几台机器上，由于 NFS 挂载的不是相同的目录，造成目录之间数据
不一致。现在用户的请求统一经过运营商的负载均衡，导致用户的内容丢失。在加上运营商机器并不是很稳定，导致服务器经常失连。
小明已经陷入了深深的运维漩涡当中，小明不想再维护了。
</p>
</div>
</li>
</ol>
</div>
<div id="outline-container-orgf0aa278" class="outline-4">
<h4 id="orgf0aa278"><span class="section-number-4">3.4.2</span> kubernetes 的历史</h4>
<div class="outline-text-4" id="text-3-4-2">
<p>
kubernetes 由 Google 内部的编排系统 Borg 演化出来
</p>

<p>
2014 年 6 月揭牌
</p>

<p>
2015年7月22日K8S迭代到 v 1.0并正式对外公布
</p>

<p>
如今已经正式版本已到 1.16.3
</p>
</div>
</div>
</div>
<div id="outline-container-org8bd0451" class="outline-3">
<h3 id="org8bd0451"><span class="section-number-3">3.5</span> kubernetes 生态与社区</h3>
<div class="outline-text-3" id="text-3-5">
</div>
<div id="outline-container-org5479822" class="outline-4">
<h4 id="org5479822"><span class="section-number-4">3.5.1</span> kubernetes 生态中的明星</h4>
<div class="outline-text-4" id="text-3-5-1">
</div>
<ol class="org-ol">
<li><a id="orgcc9eb2e"></a>网络<br />
<div class="outline-text-6" id="text-3-5-1-0-1">
<ul class="org-ul">
<li>flannel</li>
<li>calico</li>
<li>Core-DNS</li>
</ul>
</div>
</li>
<li><a id="org036a0b2"></a>存储<br />
<div class="outline-text-6" id="text-3-5-1-0-2">
<ul class="org-ul">
<li>etcd</li>
</ul>
</div>
</li>
<li><a id="orgd2c02e7"></a>其他<br />
<div class="outline-text-6" id="text-3-5-1-0-3">
<ul class="org-ul">
<li>helm</li>
<li>prometheus</li>
<li>istio</li>
<li>knative</li>
</ul>
</div>
</li>
</ol>
</div>
<div id="outline-container-orga9c002b" class="outline-4">
<h4 id="orga9c002b"><span class="section-number-4">3.5.2</span> kubernetes 社区</h4>
<div class="outline-text-4" id="text-3-5-2">
<p>
<a href="https://github.com/kubernetes/kubernetes">https://github.com/kubernetes/kubernetes</a>
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Project</th>
<th scope="col" class="org-right">contributors</th>
<th scope="col" class="org-right">commit</th>
<th scope="col" class="org-right">issue</th>
<th scope="col" class="org-right">PR</th>
<th scope="col" class="org-right">members</th>
<th scope="col" class="org-right">release</th>
<th scope="col" class="org-left">star</th>
<th scope="col" class="org-left">fork</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Docker</td>
<td class="org-right">1845</td>
<td class="org-right">38049</td>
<td class="org-right">3673</td>
<td class="org-right">197</td>
<td class="org-right">20</td>
<td class="org-right">198</td>
<td class="org-left">55.8k</td>
<td class="org-left">16.1k</td>
</tr>

<tr>
<td class="org-left">Kubernetes</td>
<td class="org-right">2378</td>
<td class="org-right">86276</td>
<td class="org-right">2244</td>
<td class="org-right">1079</td>
<td class="org-right">529</td>
<td class="org-right">586</td>
<td class="org-left">60.8k</td>
<td class="org-left">21.5k</td>
</tr>

<tr>
<td class="org-left">Tidb</td>
<td class="org-right">372</td>
<td class="org-right">9834</td>
<td class="org-right">1086</td>
<td class="org-right">136</td>
<td class="org-right">63</td>
<td class="org-right">81</td>
<td class="org-left">21.7k</td>
<td class="org-left">3.3k</td>
</tr>
</tbody>
</table>


<div class="figure">
<p><img src="images/k8s-ans.png" alt="k8s-ans.png" />
</p>
</div>


<div class="figure">
<p><img src="images/docker-ans.png" alt="docker-ans.png" />
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-orgde1acf8" class="outline-3">
<h3 id="orgde1acf8"><span class="section-number-3">3.6</span> 课后作业</h3>
<div class="outline-text-3" id="text-3-6">
<p>
1.安装 docker,并运行一个 nginx
</p>

<p>
2.给一个容器设置 &#x2013;cpus  &#x2013;cpuset-cpus 并观察 cpu 的使用
</p>

<p>
3.一个四核的机器上设置 &#x2013;cpus=2.5 &#x2013;cpuset-cpus="0,1" 那么容器最多可以占用多少 cpu 资源?为什么？
</p>

<p>
请将 1 、3 两个问题的答案发送至邮箱,截至日期为下次课程开始之前
</p>
</div>
</div>
</div>
<div id="outline-container-orgd45619b" class="outline-2">
<h2 id="orgd45619b"><span class="section-number-2">4</span> Containers 与 Pods<span class="timestamp-wrapper"><span class="timestamp">&lt;2019-12-13 Fri&gt;</span></span></h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-org7adca8e" class="outline-3">
<h3 id="org7adca8e"><span class="section-number-3">4.1</span> 课程大纲</h3>
<div class="outline-text-3" id="text-4-1">
<ul class="org-ul">
<li class="off"><code>[&#xa0;]</code> 了解 CRI 以及 CRI 的意义，从而了解 k8s 的方向</li>
<li class="off"><code>[&#xa0;]</code> 明白 pods 与 containers 的区别与关系</li>
<li class="off"><code>[&#xa0;]</code> 了解 pods 的原理</li>
<li class="off"><code>[&#xa0;]</code> 初识 k8s yaml</li>
</ul>
</div>
</div>
<div id="outline-container-org837665e" class="outline-3">
<h3 id="org837665e"><span class="section-number-3">4.2</span> CRI</h3>
<div class="outline-text-3" id="text-4-2">

<div class="figure">
<p><img src="./images/松溪观鹿图.jpeg" alt="松溪观鹿图.jpeg" />
</p>
</div>
</div>
<div id="outline-container-orge9db26f" class="outline-4">
<h4 id="orge9db26f"><span class="section-number-4">4.2.1</span> CRI 的意义</h4>
<div class="outline-text-4" id="text-4-2-1">
<p>
kubernetes 将其可以剥离开的部分转换为接口对外开放出去
</p>

<p>
1.减少核心的代码可以保证代码稳定性与产品质量
</p>

<p>
2.k8s 不依赖于某几种场景，这种方式带给 k8s 更多的可能
</p>

<p>
CRI 就是其开放出去的一个，CRI (container runtime interface)
</p>

<p>
CRI 的出现是对 Docker 的一个巨大打击 CRI 出现在 kubernetes 1.5 的版本中 2016 年 12 月，而正是此时，docker 公司正在进行他的商业化的第一步
</p>

<p>
Docker 的最大优势在于庞大的用户与及其优秀的生态,许多人都是从 Docker 才了解了容器，包括现在仍然有许多人提起容器仅能想起 Docker
</p>

<p>
kubernetes 一定不会将自己与 Docker 捆绑在同一条船上，CRI 出现之前尚可称为同床异梦,而在这之后则是真正的分居
</p>

<p>
kubernetes 在此刻已经展现了自己的爪牙
</p>
</div>
</div>
<div id="outline-container-org649327b" class="outline-4">
<h4 id="org649327b"><span class="section-number-4">4.2.2</span> CRI 的接口</h4>
<div class="outline-text-4" id="text-4-2-2">
<p>
CRI Proto<sup><a id="fnr.6" class="footref" href="#fn.6">6</a></sup>
</p>
<div class="org-src-container">
<pre class="src src-go">service <span style="color: #7aa6da;">RuntimeService</span> <span style="color: #eaeaea;">{</span>
    rpc <span style="color: #7aa6da;">Version</span><span style="color: #70c0b1;">(</span>VersionRequest<span style="color: #70c0b1;">)</span> <span style="color: #7aa6da;">returns</span> <span style="color: #70c0b1;">(</span>VersionResponse<span style="color: #70c0b1;">)</span> <span style="color: #70c0b1;">{}</span>
    rpc <span style="color: #7aa6da;">RunPodSandbox</span><span style="color: #70c0b1;">(</span>RunPodSandboxRequest<span style="color: #70c0b1;">)</span> <span style="color: #7aa6da;">returns</span> <span style="color: #70c0b1;">(</span>RunPodSandboxResponse<span style="color: #70c0b1;">)</span> <span style="color: #70c0b1;">{}</span>
    rpc <span style="color: #7aa6da;">StopPodSandbox</span><span style="color: #70c0b1;">(</span>StopPodSandboxRequest<span style="color: #70c0b1;">)</span> <span style="color: #7aa6da;">returns</span> <span style="color: #70c0b1;">(</span>StopPodSandboxResponse<span style="color: #70c0b1;">)</span> <span style="color: #70c0b1;">{}</span>
    rpc <span style="color: #7aa6da;">RemovePodSandbox</span><span style="color: #70c0b1;">(</span>RemovePodSandboxRequest<span style="color: #70c0b1;">)</span> <span style="color: #7aa6da;">returns</span> <span style="color: #70c0b1;">(</span>RemovePodSandboxResponse<span style="color: #70c0b1;">)</span> <span style="color: #70c0b1;">{}</span>
    rpc <span style="color: #7aa6da;">PodSandboxStatus</span><span style="color: #70c0b1;">(</span>PodSandboxStatusRequest<span style="color: #70c0b1;">)</span> <span style="color: #7aa6da;">returns</span> <span style="color: #70c0b1;">(</span>PodSandboxStatusResponse<span style="color: #70c0b1;">)</span> <span style="color: #70c0b1;">{}</span>
    rpc <span style="color: #7aa6da;">ListPodSandbox</span><span style="color: #70c0b1;">(</span>ListPodSandboxRequest<span style="color: #70c0b1;">)</span> <span style="color: #7aa6da;">returns</span> <span style="color: #70c0b1;">(</span>ListPodSandboxResponse<span style="color: #70c0b1;">)</span> <span style="color: #70c0b1;">{}</span>
    rpc <span style="color: #7aa6da;">CreateContainer</span><span style="color: #70c0b1;">(</span>CreateContainerRequest<span style="color: #70c0b1;">)</span> <span style="color: #7aa6da;">returns</span> <span style="color: #70c0b1;">(</span>CreateContainerResponse<span style="color: #70c0b1;">)</span> <span style="color: #70c0b1;">{}</span>
    rpc <span style="color: #7aa6da;">StartContainer</span><span style="color: #70c0b1;">(</span>StartContainerRequest<span style="color: #70c0b1;">)</span> <span style="color: #7aa6da;">returns</span> <span style="color: #70c0b1;">(</span>StartContainerResponse<span style="color: #70c0b1;">)</span> <span style="color: #70c0b1;">{}</span>
    rpc <span style="color: #7aa6da;">StopContainer</span><span style="color: #70c0b1;">(</span>StopContainerRequest<span style="color: #70c0b1;">)</span> <span style="color: #7aa6da;">returns</span> <span style="color: #70c0b1;">(</span>StopContainerResponse<span style="color: #70c0b1;">)</span> <span style="color: #70c0b1;">{}</span>
    rpc <span style="color: #7aa6da;">RemoveContainer</span><span style="color: #70c0b1;">(</span>RemoveContainerRequest<span style="color: #70c0b1;">)</span> <span style="color: #7aa6da;">returns</span> <span style="color: #70c0b1;">(</span>RemoveContainerResponse<span style="color: #70c0b1;">)</span> <span style="color: #70c0b1;">{}</span>
    rpc <span style="color: #7aa6da;">ListContainers</span><span style="color: #70c0b1;">(</span>ListContainersRequest<span style="color: #70c0b1;">)</span> <span style="color: #7aa6da;">returns</span> <span style="color: #70c0b1;">(</span>ListContainersResponse<span style="color: #70c0b1;">)</span> <span style="color: #70c0b1;">{}</span>
    rpc <span style="color: #7aa6da;">ContainerStatus</span><span style="color: #70c0b1;">(</span>ContainerStatusRequest<span style="color: #70c0b1;">)</span> <span style="color: #7aa6da;">returns</span> <span style="color: #70c0b1;">(</span>ContainerStatusResponse<span style="color: #70c0b1;">)</span> <span style="color: #70c0b1;">{}</span>
    rpc <span style="color: #7aa6da;">ExecSync</span><span style="color: #70c0b1;">(</span>ExecSyncRequest<span style="color: #70c0b1;">)</span> <span style="color: #7aa6da;">returns</span> <span style="color: #70c0b1;">(</span>ExecSyncResponse<span style="color: #70c0b1;">)</span> <span style="color: #70c0b1;">{}</span>
    rpc <span style="color: #7aa6da;">Exec</span><span style="color: #70c0b1;">(</span>ExecRequest<span style="color: #70c0b1;">)</span> <span style="color: #7aa6da;">returns</span> <span style="color: #70c0b1;">(</span>ExecResponse<span style="color: #70c0b1;">)</span> <span style="color: #70c0b1;">{}</span>
    rpc <span style="color: #7aa6da;">Attach</span><span style="color: #70c0b1;">(</span>AttachRequest<span style="color: #70c0b1;">)</span> <span style="color: #7aa6da;">returns</span> <span style="color: #70c0b1;">(</span>AttachResponse<span style="color: #70c0b1;">)</span> <span style="color: #70c0b1;">{}</span>
    rpc <span style="color: #7aa6da;">PortForward</span><span style="color: #70c0b1;">(</span>PortForwardRequest<span style="color: #70c0b1;">)</span> <span style="color: #7aa6da;">returns</span> <span style="color: #70c0b1;">(</span>PortForwardResponse<span style="color: #70c0b1;">)</span> <span style="color: #70c0b1;">{}</span>
    rpc <span style="color: #7aa6da;">UpdateRuntimeConfig</span><span style="color: #70c0b1;">(</span>UpdateRuntimeConfigRequest<span style="color: #70c0b1;">)</span> <span style="color: #7aa6da;">returns</span> <span style="color: #70c0b1;">(</span>UpdateRuntimeConfigResponse<span style="color: #70c0b1;">)</span> <span style="color: #70c0b1;">{}</span>
    rpc <span style="color: #7aa6da;">Status</span><span style="color: #70c0b1;">(</span>StatusRequest<span style="color: #70c0b1;">)</span> <span style="color: #7aa6da;">returns</span> <span style="color: #70c0b1;">(</span>StatusResponse<span style="color: #70c0b1;">)</span> <span style="color: #70c0b1;">{}</span>
<span style="color: #eaeaea;">}</span>
</pre>
</div>
<p>
这里有了个新的概念 PodSandbox
就是我们下面要说到的 Pod
</p>
</div>
</div>
</div>
<div id="outline-container-org57449e0" class="outline-3">
<h3 id="org57449e0"><span class="section-number-3">4.3</span> 容器与 Pod</h3>
<div class="outline-text-3" id="text-4-3">
</div>
<div id="outline-container-org7abe09d" class="outline-4">
<h4 id="org7abe09d"><span class="section-number-4">4.3.1</span> Pod 是什么</h4>
<div class="outline-text-4" id="text-4-3-1">

<div class="figure">
<p><img src="./images/pods.jpg" alt="pods.jpg" />
</p>
</div>

<p>
Pod 是 kubernetes 中部署与调度的最小单元
</p>

<p>
听起来是不是似曾相识
</p>
</div>
</div>
<div id="outline-container-org8354baa" class="outline-4">
<h4 id="org8354baa"><span class="section-number-4">4.3.2</span> Pod 里面有什么</h4>
<div class="outline-text-4" id="text-4-3-2">

<div class="figure">
<p><img src="./images/pods.png" alt="pods.png" />
</p>
</div>

<p>
Pod 内的容器共享网络与存储
</p>

<p>
这意味着在同一个 Pod 中的容器有着相同的 IP 与端口
</p>
</div>
</div>
<div id="outline-container-orgfec00d0" class="outline-4">
<h4 id="orgfec00d0"><span class="section-number-4">4.3.3</span> Pod 实现原理</h4>
<div class="outline-text-4" id="text-4-3-3">
<p>
pause-container 是实现 Pod 共享 namespace 的基础
</p>

<p>
在 linux 中，当你启动一个进程的时候，子进程自动继承父进程的 namespace
</p>

<p>
当你使用 unshare 的方式时会创建一个新的 namespace
</p>

<p>
pause-container 就是做这个事情的，当启动一个 Pod 时，kubernetes 创建了一个 pause 容器
</p>

<p>
并单独的创建了一个 net namespace，然后将其余的容器加入到了这个 pause 容器创建的 namespace 中
</p>

<p>
Pod 中可以配置一个参数 shareProcessNamespace 控制是否可以共享 PID
</p>

<p>
当你的 Pod 没有启用该参数时，在 container 中可以发现 pid 1 是 container commands
</p>

<p>
当启用时， pid 1 是 pause
</p>

<p>
shareProcessNamespace 会用在一些特定的场景
</p>

<p>
1.有一些镜像在 PID 不是 1 无法启动例如 systemd
</p>

<p>
2./proc 下面文件共享
</p>

<p>
3.文件系统共享 /proc/$pid/root
</p>
</div>
</div>

<div id="outline-container-orgdf70198" class="outline-4">
<h4 id="orgdf70198"><span class="section-number-4">4.3.4</span> init containers</h4>
<div class="outline-text-4" id="text-4-3-4">
<p>
在 Pod 中,你无法控制两个 container 的启动顺序，但是所有的 container 在启动之前都会先启动 init containers
</p>

<p>
init containers 可以有多个，init containers 是有顺序的
</p>

<p>
init containers 使用的是 linux namespace secrets
</p>

<p>
init containers 场景
</p>

<p>
1.加载一些工具
</p>

<p>
2.可以作为应用的部署器
</p>
</div>
</div>
<div id="outline-container-orgf5c1306" class="outline-4">
<h4 id="orgf5c1306"><span class="section-number-4">4.3.5</span> POD 的生命周期</h4>
<div class="outline-text-4" id="text-4-3-5">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">value</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Pending</td>
<td class="org-left">The Pod has been accepted by the Kubernetes system, but one or more of the Container images has not been created. This includes time before being scheduled as well as time spent downloading images over the network, which could take a while.</td>
</tr>

<tr>
<td class="org-left">Running</td>
<td class="org-left">The Pod has been bound to a node, and all of the Containers have been created. At least one Container is still running, or is in the process of starting or restarting</td>
</tr>

<tr>
<td class="org-left">Succeeded</td>
<td class="org-left">All Containers in the Pod have terminated in success, and will not be restarted.</td>
</tr>

<tr>
<td class="org-left">Failed</td>
<td class="org-left">All Containers in the Pod have terminated, and at least one Container has terminated in failure. That is, the Container either exited with non-zero status or was terminated by the system.</td>
</tr>

<tr>
<td class="org-left">Unknown</td>
<td class="org-left">For some reason the state of the Pod could not be obtained, typically due to an error in communicating with the host of the Pod</td>
</tr>
</tbody>
</table>

<div class="figure">
<p><img src="./images/pod-phase.png" alt="pod-phase.png" />
</p>
</div>
</div>
</div>
<div id="outline-container-orgcad4554" class="outline-4">
<h4 id="orgcad4554"><span class="section-number-4">4.3.6</span> Pod 的回收</h4>
<div class="outline-text-4" id="text-4-3-6">
<p>
Pod 的回收在 kubernetes 中面临这样几个问题:
</p>

<p>
1.清理 Pod 这个资源
</p>

<p>
2.清理 Pod 关联的其他资源
</p>

<p>
3.清理 Pod 中的容器
</p>

<p>
简单的来看是这样的一个流程,但这其中还涉及 kubelet 的垃圾回收机制, 会在之后的章节中详细说明
</p>

<p>
客户端请求删除 Pod &#x2013;&gt;
</p>

<p>
apiserver 更新 Pod 信息 &#x2013;&gt;
</p>

<p>
kubelet 优雅释放 Pod 资源 &#x2013;&gt;
</p>

<p>
kubelet 请求删除 Pod &#x2013;&gt;
</p>

<p>
apiserver 删除 etcd 中 Pod 信息&#x2013;&gt;
</p>

<p>
kubelet完成最终Pod的资源清理
</p>
</div>
</div>
<div id="outline-container-org9fede64" class="outline-4">
<h4 id="org9fede64"><span class="section-number-4">4.3.7</span> multi Pod 的实际场景</h4>
<div class="outline-text-4" id="text-4-3-7">
<p>
     <img src="./images/sidecar.jpeg" alt="sidecar.jpeg" />
sidecar 到 service mesh
</p>

<p>
如果说 kubernetes 管理你的基础设施 service mesh 则管理应用的全部
</p>

<p>
比如说 服务发现 融断 负载均衡 灰度发布甚至安全
<img src="./images/service-mesh-nginx.png" alt="service-mesh-nginx.png" />
</p>
</div>
</div>
</div>
<div id="outline-container-org81ae388" class="outline-3">
<h3 id="org81ae388"><span class="section-number-3">4.4</span> 课后作业</h3>
<div class="outline-text-3" id="text-4-4">
<p>
1.简单论述 OCI 与 CRI 的区别
</p>

<p>
2.使用提供的工具模拟一个 Pod
tools:
</p>
<ul class="org-ul">
<li>unshare</li>
<li>docker run</li>
</ul>
<p>
images:
</p>
<ul class="org-ul">
<li>nginx</li>
<li>daocloud.io/daocloud/dao-2048</li>
<li>gcr.azk8s.cn/google_containers/pause:3.1</li>
</ul>
<p>
config:
</p>
<div class="org-src-container">
<pre class="src src-nginx"><span style="color: #b9ca4a;">cat</span> &lt;&lt;EOF &gt;&gt; nginx.conf
<span style="color: #b9ca4a;">error_log</span> stderr;
<span style="color: #b9ca4a;">events</span> <span style="color: #eaeaea;">{</span> worker_connections  1024; <span style="color: #eaeaea;">}</span>
<span style="color: #b9ca4a;">http</span> <span style="color: #eaeaea;">{</span>
    <span style="color: #b9ca4a;">access_log</span> /dev/stdout combined;
    <span style="color: #b9ca4a;">server</span> <span style="color: #70c0b1;">{</span>
        <span style="color: #b9ca4a;">listen</span> 8080 default_server;
        <span style="color: #b9ca4a;">server_name</span> example.com www.example.com;
        <span style="color: #b9ca4a;">location</span> <span style="color: #e78c45;">/</span> <span style="color: #e7c547;">{</span>
            <span style="color: #b9ca4a;">proxy_pass</span> http://127.0.0.1:80;
        <span style="color: #e7c547;">}</span>
    <span style="color: #70c0b1;">}</span>
<span style="color: #eaeaea;">}</span>
<span style="color: #b9ca4a;">EOF</span>
</pre>
</div>
<p>
1.nginx 不暴露端口
</p>

<p>
2.pause 暴露端口 30001:8080
</p>

<p>
3.2048 不暴露端口
</p>

<p>
4.当访问本地的 30001 端口时可以出现 2048 游戏界面
</p>
</div>
</div>
</div>
<div id="outline-container-org0f41cc4" class="outline-2">
<h2 id="org0f41cc4"><span class="section-number-2">5</span> Yaml 与 kubectl <span class="timestamp-wrapper"><span class="timestamp">&lt;2019-12-20 Fri&gt;</span></span></h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-org5996e88" class="outline-3">
<h3 id="org5996e88"><span class="section-number-3">5.1</span> 课程大纲</h3>
<div class="outline-text-3" id="text-5-1">
<ul class="org-ul">
<li class="off"><code>[&#xa0;]</code> 了解 kubernetes yaml 的格式</li>
<li class="off"><code>[&#xa0;]</code> kubectl 常用的命令</li>
<li class="off"><code>[&#xa0;]</code> kubectl 的使用g</li>
</ul>
</div>
</div>
<div id="outline-container-org7b4e0e3" class="outline-3">
<h3 id="org7b4e0e3"><span class="section-number-3">5.2</span> kubernetes yaml</h3>
<div class="outline-text-3" id="text-5-2">
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #e7c547;">apiVersion</span>: v1
<span style="color: #e7c547;">kind</span>: Pod
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">annotations</span>:
    <span style="color: #e7c547;">cni.projectcalico.org/podIP</span>: 192.168.159.56/32
  <span style="color: #e7c547;">labels</span>:
    <span style="color: #e7c547;">app</span>: nginx
  <span style="color: #e7c547;">name</span>: nginx-pod-test1
  <span style="color: #e7c547;">namespace</span>: default
<span style="color: #e7c547;">spec</span>:
  <span style="color: #e7c547;">containers</span>:
  - <span style="color: #e7c547;">image</span>: nginx:1.7.9
    <span style="color: #e7c547;">imagePullPolicy</span>: Always
    <span style="color: #e7c547;">name</span>: nginx
    <span style="color: #e7c547;">ports</span>:
    - <span style="color: #e7c547;">containerPort</span>: 80
      <span style="color: #e7c547;">protocol</span>: TCP
    <span style="color: #e7c547;">resources</span>:
      <span style="color: #e7c547;">requests</span>:
        <span style="color: #e7c547;">memory</span>: <span style="color: #70c0b1;">"30Mi"</span>
      <span style="color: #e7c547;">limits</span>:
        <span style="color: #e7c547;">memory</span>: <span style="color: #70c0b1;">"200Mi"</span>
  <span style="color: #e7c547;">restartPolicy</span>: Always
  <span style="color: #e7c547;">schedulerName</span>: default-scheduler
  <span style="color: #e7c547;">terminationGracePeriodSeconds</span>: 30
  <span style="color: #e7c547;">tolerations</span>:
  - <span style="color: #e7c547;">effect</span>: NoExecute
    <span style="color: #e7c547;">key</span>: node.kubernetes.io/not-ready
    <span style="color: #e7c547;">operator</span>: Exists
    <span style="color: #e7c547;">tolerationSeconds</span>: 300
  - <span style="color: #e7c547;">effect</span>: NoExecute
    <span style="color: #e7c547;">key</span>: node.kubernetes.io/unreachable
    <span style="color: #e7c547;">operator</span>: Exists
    <span style="color: #e7c547;">tolerationSeconds</span>: 300
</pre>
</div>
</div>
<div id="outline-container-org73fabe6" class="outline-4">
<h4 id="org73fabe6"><span class="section-number-4">5.2.1</span> annotation</h4>
<div class="outline-text-4" id="text-5-2-1">
<p>
注释以 kv 的方式存储
</p>

<p>
有最大长度限制
</p>
</div>
</div>
<div id="outline-container-org49f48a9" class="outline-4">
<h4 id="org49f48a9"><span class="section-number-4">5.2.2</span> label &amp;&amp; selector</h4>
<div class="outline-text-4" id="text-5-2-2">
<p>
用来调度与标明身份
</p>

<p>
是 kubernetes 判断身份的基础
</p>
</div>
</div>
<div id="outline-container-org2de37eb" class="outline-4">
<h4 id="org2de37eb"><span class="section-number-4">5.2.3</span> namespace</h4>
<div class="outline-text-4" id="text-5-2-3">
<pre class="example">
kubectl get ns
</pre>
<p>
1.default
</p>

<p>
2.kube-system kubernetes 系统的
</p>

<p>
3.kube-public 用来对集群所有用户可读的
</p>
</div>
</div>
<div id="outline-container-orgeb7f9a5" class="outline-4">
<h4 id="orgeb7f9a5"><span class="section-number-4">5.2.4</span> apiVersion</h4>
<div class="outline-text-4" id="text-5-2-4">
<p>
kubernetes 采用了标准的 REST API, 外部的用户命令与组件之间的通信，经过 apiserver 的部分都会使用 RESTAPI
</p>
</div>

<ol class="org-ol">
<li><a id="org4594f1c"></a>RESTful API<br />
<div class="outline-text-5" id="text-5-2-4-1">
<ul class="org-ul">
<li>一切皆是资源</li>
<li>url 中指定了版本</li>
<li>头部表示 schema</li>
<li>使用 HTTP 的 Method 的与返回码</li>
</ul>
</div>
</li>

<li><a id="org110ac8f"></a>API 版本信息<br />
<div class="outline-text-5" id="text-5-2-4-2">
<p>
1.alpha 所有包含 alpha 的; feature 可能被修改或删除，可能有 bug，默认禁用
</p>

<p>
2.beta 所有包含 beta 的; 经过测试,默认启用,可能会修改细节但是不会删除
</p>

<p>
3.stable 的版本 v(x)
</p>
</div>
</li>

<li><a id="orgd968ac7"></a>API 组<br />
<div class="outline-text-5" id="text-5-2-4-3">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">/api/v1</td>
<td class="org-left">/api/v1</td>
<td class="org-left">apiVersion: v1</td>
</tr>

<tr>
<td class="org-left">apis/$GROUP_NAME/$VERSION</td>
<td class="org-left">$GROUP_NAME/$VERSION</td>
<td class="org-left">apiVersion: batch/v1</td>
</tr>
</tbody>
</table>
</div>
</li>
</ol>
</div>

<div id="outline-container-orgaca9857" class="outline-4">
<h4 id="orgaca9857"><span class="section-number-4">5.2.5</span> toleration &amp;&amp; taint</h4>
<div class="outline-text-4" id="text-5-2-5">
<pre class="example">
kubectl taint nodes node1 key=value:NoSchedule
</pre>
<p>
给节点 node1 打了一个污点 key value effact
所有的 pod 都不会被调度到这台机器上，除非存在相应的容忍
</p>
</div>
</div>
</div>

<div id="outline-container-orga8a45c1" class="outline-3">
<h3 id="orga8a45c1"><span class="section-number-3">5.3</span> kubectl</h3>
<div class="outline-text-3" id="text-5-3">
</div>
<div id="outline-container-org18a1844" class="outline-4">
<h4 id="org18a1844"><span class="section-number-4">5.3.1</span> kubectl get</h4>
<div class="outline-text-4" id="text-5-3-1">
<div class="org-src-container">
<pre class="src src-shell">kubectl get po $<span style="color: #e7c547;">podname</span> -o wide
</pre>
</div>
</div>
</div>
<div id="outline-container-org0bd7ba8" class="outline-4">
<h4 id="org0bd7ba8"><span class="section-number-4">5.3.2</span> kubectl apply</h4>
<div class="outline-text-4" id="text-5-3-2">
<p>
kubectl apply -f <b><b><b>*</b></b></b>.yaml
</p>
</div>
</div>
<div id="outline-container-org2e20041" class="outline-4">
<h4 id="org2e20041"><span class="section-number-4">5.3.3</span> kubectl logs</h4>
<div class="outline-text-4" id="text-5-3-3">
<div class="org-src-container">
<pre class="src src-shell">kubectl logs -f $<span style="color: #e7c547;">podname</span> <span style="color: #eaeaea;">[</span>-c<span style="color: #eaeaea;">]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org734743a" class="outline-4">
<h4 id="org734743a"><span class="section-number-4">5.3.4</span> kubectl exec</h4>
<div class="outline-text-4" id="text-5-3-4">
<div class="org-src-container">
<pre class="src src-shell">kubectl exec -it <span style="color: #eaeaea;">[</span>-p<span style="color: #eaeaea;">]</span> $<span style="color: #e7c547;">podname</span> <span style="color: #eaeaea;">[</span>-c<span style="color: #eaeaea;">]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgbb6d108" class="outline-4">
<h4 id="orgbb6d108"><span class="section-number-4">5.3.5</span> kubectl edit</h4>
<div class="outline-text-4" id="text-5-3-5">
<div class="org-src-container">
<pre class="src src-shell">kubectl edit $<span style="color: #e7c547;">resource</span> $<span style="color: #e7c547;">name</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org11d4e80" class="outline-3">
<h3 id="org11d4e80"><span class="section-number-3">5.4</span> 作业</h3>
<div class="outline-text-3" id="text-5-4">
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #e7c547;">apiVersion</span>: v1
<span style="color: #e7c547;">kind</span>: Pod
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">name</span>: memory-demo-2
  <span style="color: #e7c547;">namespace</span>: mem-example
<span style="color: #e7c547;">spec</span>:
  <span style="color: #e7c547;">containers</span>:
  - <span style="color: #e7c547;">name</span>: memory-demo-2-ctr
    <span style="color: #e7c547;">image</span>: polinux/stress
    <span style="color: #e7c547;">resources</span>:
      <span style="color: #e7c547;">requests</span>:
        <span style="color: #e7c547;">memory</span>: <span style="color: #70c0b1;">"50Mi"</span>
      <span style="color: #e7c547;">limits</span>:
        <span style="color: #e7c547;">memory</span>: <span style="color: #70c0b1;">"100Mi"</span>
    <span style="color: #e7c547;">command</span>: [<span style="color: #70c0b1;">"stress"</span>]
    <span style="color: #e7c547;">args</span>: [<span style="color: #70c0b1;">"--vm"</span>, <span style="color: #70c0b1;">"1"</span>, <span style="color: #70c0b1;">"--vm-bytes"</span>, <span style="color: #70c0b1;">"250M"</span>, <span style="color: #70c0b1;">"--vm-hang"</span>, <span style="color: #70c0b1;">"1"</span>]
</pre>
</div>
<p>
1.描述启动该 yaml 时出现了什么情况(报错与 pod 状态)，并解释为什么
</p>

<p>
2.修改这个 yaml 使得该 pod 可以运行
</p>

<p>
<a href="https://www.katacoda.com/courses/kubernetes/playground">https://www.katacoda.com/courses/kubernetes/playground</a>
</p>
</div>
</div>
</div>
<div id="outline-container-org468539c" class="outline-2">
<h2 id="org468539c"><span class="section-number-2">6</span> Pod controllers <span class="timestamp-wrapper"><span class="timestamp">&lt;2019-12-27 Fri&gt;</span></span></h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-orgfdcd56f" class="outline-3">
<h3 id="orgfdcd56f"><span class="section-number-3">6.1</span> 课程大纲</h3>
<div class="outline-text-3" id="text-6-1">
<ul class="org-ul">
<li class="off"><code>[&#xa0;]</code> 了解 pod 在 k8s 中如何被控制</li>
<li class="off"><code>[&#xa0;]</code> 了解 k8s 常用的 poc controller 以及作用</li>
</ul>
</div>
</div>
<div id="outline-container-orgab8cd88" class="outline-3">
<h3 id="orgab8cd88"><span class="section-number-3">6.2</span> Replicaset (rs)</h3>
<div class="outline-text-3" id="text-6-2">
<p>
rs 是用来保证 pod 运行数量的
</p>

<p>
rs 提供了基础的管理 pod 的能力，保证符合预期数量的 pod 正常启动
</p>

<p>
现在的 rs 都是伴随着 deploy 进行使用,不建议手动进行更改
</p>
<div class="org-src-container">
<pre class="src src-shell">kubect get rs &#215;&#215;&#215; -o yaml
</pre>
</div>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #e7c547;">apiVersion</span>: apps/v1
<span style="color: #e7c547;">kind</span>: ReplicaSet
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">annotations</span>:
    <span style="color: #e7c547;">deployment.kubernetes.io/desired-replicas</span>: <span style="color: #70c0b1;">"5"</span>
    <span style="color: #e7c547;">deployment.kubernetes.io/max-replicas</span>: <span style="color: #70c0b1;">"7"</span>
    <span style="color: #e7c547;">deployment.kubernetes.io/revision</span>: <span style="color: #70c0b1;">"5"</span>
    <span style="color: #e7c547;">deployment.kubernetes.io/revision-history</span>: <span style="color: #70c0b1;">"3"</span>
  <span style="color: #e7c547;">creationTimestamp</span>: <span style="color: #70c0b1;">"2019-12-26T11:02:23Z"</span>
  <span style="color: #e7c547;">generation</span>: 7
  <span style="color: #e7c547;">labels</span>:
    <span style="color: #e7c547;">app</span>: nginx
    <span style="color: #e7c547;">pod-template-hash</span>: 765bd9f9c
    <span style="color: #e7c547;">test</span>: <span style="color: #70c0b1;">"123"</span>
  <span style="color: #e7c547;">name</span>: nginx-deployment-765bd9f9c
  <span style="color: #e7c547;">namespace</span>: default
  <span style="color: #e7c547;">ownerReferences</span>:
  - <span style="color: #e7c547;">apiVersion</span>: apps/v1
    <span style="color: #e7c547;">blockOwnerDeletion</span>: <span style="color: #7aa6da;">true</span>
    <span style="color: #e7c547;">controller</span>: <span style="color: #7aa6da;">true</span>
    <span style="color: #e7c547;">kind</span>: Deployment
    <span style="color: #e7c547;">name</span>: nginx-deployment
    <span style="color: #e7c547;">uid</span>: 2f0afdde-f57e-42df-9f57-781fd5cb2391
  <span style="color: #e7c547;">resourceVersion</span>: <span style="color: #70c0b1;">"4850637"</span>
  <span style="color: #e7c547;">selfLink</span>: /apis/apps/v1/namespaces/default/replicasets/nginx-deployment-765bd9f9c
  <span style="color: #e7c547;">uid</span>: fdbce8f5-0e5a-418f-8ffb-68e33901da1c
<span style="color: #e7c547;">spec</span>:
  <span style="color: #e7c547;">replicas</span>: 5
  <span style="color: #e7c547;">selector</span>:
    <span style="color: #e7c547;">matchLabels</span>:
      <span style="color: #e7c547;">app</span>: nginx
      <span style="color: #e7c547;">pod-template-hash</span>: 765bd9f9c
  <span style="color: #e7c547;">template</span>:
    <span style="color: #e7c547;">metadata</span>:
      <span style="color: #e7c547;">creationTimestamp</span>: <span style="color: #7aa6da;">null</span>
      <span style="color: #e7c547;">labels</span>:
        <span style="color: #e7c547;">app</span>: nginx
        <span style="color: #e7c547;">pod-template-hash</span>: 765bd9f9c
        <span style="color: #e7c547;">test</span>: <span style="color: #70c0b1;">"123"</span>
    <span style="color: #e7c547;">spec</span>:
      <span style="color: #e7c547;">containers</span>:
      - <span style="color: #e7c547;">image</span>: nginx:1.7.9
        <span style="color: #e7c547;">imagePullPolicy</span>: Always
        <span style="color: #e7c547;">name</span>: nginx
        <span style="color: #e7c547;">ports</span>:
        - <span style="color: #e7c547;">containerPort</span>: 80
          <span style="color: #e7c547;">protocol</span>: TCP
        <span style="color: #e7c547;">resources</span>: {<span style="color: #e7c547;">}</span>
<span style="color: #e7c547;">        terminationMessagePath</span>: /dev/termination-log
        <span style="color: #e7c547;">terminationMessagePolicy</span>: File
      <span style="color: #e7c547;">dnsPolicy</span>: ClusterFirst
      <span style="color: #e7c547;">restartPolicy</span>: Always
      <span style="color: #e7c547;">schedulerName</span>: default-scheduler
      <span style="color: #e7c547;">securityContext</span>: {<span style="color: #e7c547;">}</span>
<span style="color: #e7c547;">      terminationGracePeriodSeconds</span>: 30
<span style="color: #e7c547;">status</span>:
  <span style="color: #e7c547;">availableReplicas</span>: 5
  <span style="color: #e7c547;">fullyLabeledReplicas</span>: 5
  <span style="color: #e7c547;">observedGeneration</span>: 7
  <span style="color: #e7c547;">readyReplicas</span>: 5
  <span style="color: #e7c547;">replicas</span>: 5
</pre>
</div>
</div>
</div>
<div id="outline-container-org105e399" class="outline-3">
<h3 id="org105e399"><span class="section-number-3">6.3</span> ReplicationController (rc)</h3>
<div class="outline-text-3" id="text-6-3">
<p>
rc 是时代的眼泪 早期用来对 pod 的控制使用 rc 完成，但现在有了更高级的 deploy
</p>
</div>
</div>
<div id="outline-container-org10e263a" class="outline-3">
<h3 id="org10e263a"><span class="section-number-3">6.4</span> Deployments (deploy)</h3>
<div class="outline-text-3" id="text-6-4">
<p>
deploy 是 k8s 中很重要的一个概念，可以看作无状态应用的管理器
</p>

<p>
deploy 提供了对 rs 与 pod 的声明式的更新
</p>

<p>
先来看这个样一个 yaml
</p>
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #e7c547;">apiVersion</span>: apps/v1
<span style="color: #e7c547;">kind</span>: Deployment
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">name</span>: nginx-deployment
<span style="color: #e7c547;">spec</span>:
  <span style="color: #e7c547;">selector</span>:
    <span style="color: #e7c547;">matchLabels</span>:
      <span style="color: #e7c547;">app</span>: nginx
  <span style="color: #e7c547;">replicas</span>: 2
  <span style="color: #e7c547;">template</span>:
    <span style="color: #e7c547;">metadata</span>:
      <span style="color: #e7c547;">labels</span>:
        <span style="color: #e7c547;">app</span>: nginx
    <span style="color: #e7c547;">spec</span>:
      <span style="color: #e7c547;">containers</span>:
      - <span style="color: #e7c547;">name</span>: nginx
        <span style="color: #e7c547;">image</span>: nginx:1.7.9
        <span style="color: #e7c547;">ports</span>:
          - <span style="color: #e7c547;">containerPort</span>: 80
</pre>
</div>

<p>
这里创建了一个 名为 nginx-deployment 的 deploy
</p>

<p>
这时你可以找到这个 deploy 对应的 rs 与 pod
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #e7c547;">apiVersion</span>: apps/v1
<span style="color: #e7c547;">kind</span>: ReplicaSet
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">annotations</span>:
    <span style="color: #e7c547;">deployment.kubernetes.io/desired-replicas</span>: <span style="color: #70c0b1;">"1"</span>
    <span style="color: #e7c547;">deployment.kubernetes.io/max-replicas</span>: <span style="color: #70c0b1;">"2"</span>
    <span style="color: #e7c547;">deployment.kubernetes.io/revision</span>: <span style="color: #70c0b1;">"2"</span>
  <span style="color: #e7c547;">creationTimestamp</span>: <span style="color: #70c0b1;">"2019-11-05T01:34:29Z"</span>
  <span style="color: #e7c547;">generation</span>: 10
  <span style="color: #e7c547;">labels</span>:
    <span style="color: #e7c547;">app</span>: nginx
    <span style="color: #e7c547;">pod-template-hash</span>: 5b7b9ccb95
  <span style="color: #e7c547;">name</span>: nginx-deployment-5b7b9ccb95
  <span style="color: #e7c547;">namespace</span>: default
  <span style="color: #e7c547;">ownerReferences</span>:
  - <span style="color: #e7c547;">apiVersion</span>: apps/v1
    <span style="color: #e7c547;">blockOwnerDeletion</span>: <span style="color: #7aa6da;">true</span>
    <span style="color: #e7c547;">controller</span>: <span style="color: #7aa6da;">true</span>
    <span style="color: #e7c547;">kind</span>: Deployment
    <span style="color: #e7c547;">name</span>: nginx-deployment
    <span style="color: #e7c547;">uid</span>: 2f0afdde-f57e-42df-9f57-781fd5cb2391
  <span style="color: #e7c547;">resourceVersion</span>: <span style="color: #70c0b1;">"3898865"</span>
  <span style="color: #e7c547;">selfLink</span>: /apis/apps/v1/namespaces/default/replicasets/nginx-deployment-5b7b9ccb95
  <span style="color: #e7c547;">uid</span>: c87ebc79-38d3-4ce2-b581-c63851d7adef
<span style="color: #e7c547;">spec</span>:
  <span style="color: #e7c547;">replicas</span>: 1
  <span style="color: #e7c547;">selector</span>:
    <span style="color: #e7c547;">matchLabels</span>:
      <span style="color: #e7c547;">app</span>: nginx
      <span style="color: #e7c547;">pod-template-hash</span>: 5b7b9ccb95
  <span style="color: #e7c547;">template</span>:
    <span style="color: #e7c547;">metadata</span>:
      <span style="color: #e7c547;">creationTimestamp</span>: <span style="color: #7aa6da;">null</span>
      <span style="color: #e7c547;">labels</span>:
        <span style="color: #e7c547;">app</span>: nginx
        <span style="color: #e7c547;">pod-template-hash</span>: 5b7b9ccb95
    <span style="color: #e7c547;">spec</span>:
      <span style="color: #e7c547;">containers</span>:
      - <span style="color: #e7c547;">image</span>: nginx:1.7.9
        <span style="color: #e7c547;">imagePullPolicy</span>: Always
        <span style="color: #e7c547;">name</span>: nginx
        <span style="color: #e7c547;">ports</span>:
        - <span style="color: #e7c547;">containerPort</span>: 80
          <span style="color: #e7c547;">protocol</span>: TCP
        <span style="color: #e7c547;">resources</span>: {<span style="color: #e7c547;">}</span>
<span style="color: #e7c547;">        terminationMessagePath</span>: /dev/termination-log
        <span style="color: #e7c547;">terminationMessagePolicy</span>: File
      <span style="color: #e7c547;">dnsPolicy</span>: ClusterFirst
      <span style="color: #e7c547;">restartPolicy</span>: Always
      <span style="color: #e7c547;">schedulerName</span>: default-scheduler
      <span style="color: #e7c547;">securityContext</span>: {<span style="color: #e7c547;">}</span>
<span style="color: #e7c547;">      terminationGracePeriodSeconds</span>: 30
<span style="color: #e7c547;">status</span>:
  <span style="color: #e7c547;">availableReplicas</span>: 1
  <span style="color: #e7c547;">fullyLabeledReplicas</span>: 1
  <span style="color: #e7c547;">observedGeneration</span>: 10
  <span style="color: #e7c547;">readyReplicas</span>: 1
  <span style="color: #e7c547;">replicas</span>: 1
</pre>
</div>

<p>
rs 中有一个很重要的字段叫做 ownerReferences 标识这个 rs 是属于哪一个 deploy 的
</p>

<p>
同样你可以在 pod 中也找到相应的字段,来标识这个 pod 是受到哪个 rs 管理的
</p>

<p>
selector 的标签用来标识最终会控制哪个 pod
</p>

<p>
我们会发现在 rs 中，除了我们设置的标签外还有一个新的标签 pod-template-hash
</p>

<p>
这个标签用来保证一个 deploy 所对应的 rs 不会发生重叠
</p>
</div>
<div id="outline-container-org046219a" class="outline-4">
<h4 id="org046219a"><span class="section-number-4">6.4.1</span> 更新一个 deploy</h4>
<div class="outline-text-4" id="text-6-4-1">
<p>
当更改了 deploy 中的资源时，deploy 就会进行更新,deploy 的更新同时会更新所属的 rs 与 pod
</p>
</div>
</div>
<div id="outline-container-orge06392a" class="outline-4">
<h4 id="orge06392a"><span class="section-number-4">6.4.2</span> 滚动发布</h4>
<div class="outline-text-4" id="text-6-4-2">
<div class="org-src-container">
<pre class="src src-shell">kubectl rollout
</pre>
</div>
<p>
回滚可以针对 deploy daemonset statefulset
</p>

<p>
当更改一个资源时可以使用 &#x2013;record 对当前的这条命令进行记录
</p>
<pre class="example">
kubectl appf -f ***.yaml --record
</pre>
<p>
使用 history 可以看到一个 deploy 的变化记录
</p>

<pre class="example">
kubectl rollout history deploy nginx-deployment
</pre>

<p>
然后使用 undo 进行回滚, 使用 &#x2013;to-revision 可以选择回滚到的版本
</p>
<pre class="example">
kubectl rollout undo  deploy  nginx-deployment
</pre>
</div>
</div>
<div id="outline-container-orga11771a" class="outline-4">
<h4 id="orga11771a"><span class="section-number-4">6.4.3</span> 扩展</h4>
<div class="outline-text-4" id="text-6-4-3">
<p>
使用 scale 可以 deploy 的副本数进行更改
</p>
<pre class="example">
kubectl scale deploy nginx-deployment
</pre>
<p>
同样也是对 rs 的更改
</p>
</div>
</div>
<div id="outline-container-orgaea4e67" class="outline-4">
<h4 id="orgaea4e67"><span class="section-number-4">6.4.4</span> 自动扩展</h4>
<div class="outline-text-4" id="text-6-4-4">
<p>
HPA 的机制较为复杂会在后面的章节详细讲解
</p>
</div>
</div>
</div>
<div id="outline-container-org9317faf" class="outline-3">
<h3 id="org9317faf"><span class="section-number-3">6.5</span> Jobs</h3>
<div class="outline-text-3" id="text-6-5">
<p>
job 主要用来执行一次性的任务
</p>

<p>
在 k8s 中 job 有几种不同的类型使用 spec.parallelism 和 spec.completions 进行配置
</p>

<p>
completions 标识几个 pod 运行结束后 job 进入到完成状态
</p>

<p>
parallelism 标识同时有几个 pod 一起运行
</p>
</div>

<div id="outline-container-orga16bb0c" class="outline-4">
<h4 id="orga16bb0c"><span class="section-number-4">6.5.1</span> 不同的 job</h4>
<div class="outline-text-4" id="text-6-5-1">
<p>
1.非并行的 job
</p>

<p>
2.固定结束次数的 job
</p>

<p>
3.带有工作队列的并行 job
</p>


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Job类型</th>
<th scope="col" class="org-left">使用示例</th>
<th scope="col" class="org-left">行为</th>
<th scope="col" class="org-right">completions</th>
<th scope="col" class="org-right">Parallelism</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">一次性Job</td>
<td class="org-left">数据库迁移</td>
<td class="org-left">创建一个Pod直至其成功结束</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-left">固定结束次数的Job</td>
<td class="org-left">处理工作队列的Pod</td>
<td class="org-left">依次创建一个Pod运行直至completions个成功结束</td>
<td class="org-right">2+</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-left">固定结束次数的并行Job</td>
<td class="org-left">多个Pod同时处理工作队列</td>
<td class="org-left">依次创建多个Pod运行直至completions个成功结束</td>
<td class="org-right">2+</td>
<td class="org-right">2+</td>
</tr>

<tr>
<td class="org-left">并行Job</td>
<td class="org-left">多个Pod同时处理工作队列</td>
<td class="org-left">创建一个或多个Pod直至有一个成功结束</td>
<td class="org-right">1</td>
<td class="org-right">2+</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

<div id="outline-container-org19c0fa7" class="outline-3">
<h3 id="org19c0fa7"><span class="section-number-3">6.6</span> CronJob</h3>
<div class="outline-text-3" id="text-6-6">
<p>
cronjob 以类似 crontab 的方式进行调度 job
</p>
</div>

<div id="outline-container-orgdd917f5" class="outline-4">
<h4 id="orgdd917f5"><span class="section-number-4">6.6.1</span> 什么是 crontab</h4>
<div class="outline-text-4" id="text-6-6-1">
<p>
<a href="https://linux.die.net/man/1/crontab">https://linux.die.net/man/1/crontab</a>
</p>

<p>
推荐一个网站 <a href="https://crontab.guru/">https://crontab.guru/</a> 方便更好的理解 crontab
</p>
</div>
</div>
</div>
<div id="outline-container-org7dceb4a" class="outline-3">
<h3 id="org7dceb4a"><span class="section-number-3">6.7</span> DaemonSet (ds)</h3>
<div class="outline-text-3" id="text-6-7">
<p>
daemonset 确保集群内的每一台机器上都运行 ds 下的 pod
</p>

<p>
使用场景：
</p>

<p>
1.有一些集群存储的 daemon 例如:glusterd, ceph
</p>

<p>
2.每台机器上都需要有的日志收集与监控  logstash datadog
</p>

<p>
3.网络方案中需要部署在每台机器上的实例 calico
</p>
</div>
<div id="outline-container-org155f27c" class="outline-4">
<h4 id="org155f27c"><span class="section-number-4">6.7.1</span> 如果 ds 遇到 taint 如何处理？</h4>
<div class="outline-text-4" id="text-6-7-1">
<p>
k8s 会自动添加 tolearation 到 ds 的 pod 上
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">toleration key</th>
<th scope="col" class="org-left">effect</th>
<th scope="col" class="org-right">version</th>
<th scope="col" class="org-left">description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">node.kubernetes.io/not-ready</td>
<td class="org-left">NoExecute</td>
<td class="org-right">1.13+</td>
<td class="org-left">DaemonSet pods will not be evicted when there are node problems such as a network partition.</td>
</tr>

<tr>
<td class="org-left">node.kubernetes.io/unreachable</td>
<td class="org-left">NoExecute</td>
<td class="org-right">1.13+</td>
<td class="org-left">DaemonSet pods will not be evicted when there are node problems such as a network partition.</td>
</tr>

<tr>
<td class="org-left">node.kubernetes.io/disk-pressure</td>
<td class="org-left">NoSchedule</td>
<td class="org-right">1.8+</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">node.kubernetes.io/memory-pressure</td>
<td class="org-left">NoSchedule</td>
<td class="org-right">1.8+</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">node.kubernetes.io/unschedulable</td>
<td class="org-left">NoSchedule</td>
<td class="org-right">1.12+</td>
<td class="org-left">DaemonSet pods tolerate unschedulable attributes by default scheduler.</td>
</tr>

<tr>
<td class="org-left">node.kubernetes.io/network-unavailable</td>
<td class="org-left">NoSchedule</td>
<td class="org-right">1.12+</td>
<td class="org-left">DaemonSet pods, who uses host network, tolerate network-unavailable attributes by default scheduler.</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

<div id="outline-container-orgdc037a0" class="outline-3">
<h3 id="orgdc037a0"><span class="section-number-3">6.8</span> 课后作业</h3>
<div class="outline-text-3" id="text-6-8">
<p>
1.创建一个 nginx 的 deploy
  名称为 nginx-c4
  有两个副本
</p>

<p>
2.更改 1 中创建的 deploy 的副本数为 4,并将镜像改为 daocloud.io/daocloud/dao-2048
</p>

<p>
3.回滚至两个副本的版本
</p>

<p>
4.观察在回滚的过程中 deploy annotation 的变化
</p>
</div>
</div>
</div>
<div id="outline-container-org5a51f15" class="outline-2">
<h2 id="org5a51f15"><span class="section-number-2">7</span> 有状态、无状态与 Cloud native <span class="timestamp-wrapper"><span class="timestamp">&lt;2020-01-03 Fri&gt;</span></span></h2>
<div class="outline-text-2" id="text-7">
</div>
<div id="outline-container-org9a53d94" class="outline-3">
<h3 id="org9a53d94"><span class="section-number-3">7.1</span> 课程大纲</h3>
<div class="outline-text-3" id="text-7-1">
<ul class="org-ul">
<li class="off"><code>[&#xa0;]</code> 可以分辨有状态的服务与无状态的服务</li>
<li class="off"><code>[&#xa0;]</code> 了解 StatefulSet 的意义并可以在 k8s 集群中进行管理</li>
<li class="off"><code>[&#xa0;]</code> 对 Cloud-native 的意义有一个基本的认识</li>
</ul>
</div>
</div>
<div id="outline-container-org1ce35c2" class="outline-3">
<h3 id="org1ce35c2"><span class="section-number-3">7.2</span> 无中生有</h3>
<div class="outline-text-3" id="text-7-2">
</div>
<div id="outline-container-orgecf8463" class="outline-4">
<h4 id="orgecf8463"><span class="section-number-4">7.2.1</span> 什么是幂等性</h4>
<div class="outline-text-4" id="text-7-2-1">
<p>
本章所讲的幂等性仅指 RESTful API 的 HTTP
</p>

<p>
HTTP 中的幂等性指的是一次请求与多次请求同一个资源会产生相同的副作用
</p>

<p>
简单来讲，对一个 API 进行多次操作，是不是每次对系统的影响都是都是相同的
</p>


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">方法</th>
<th scope="col" class="org-left">幂等</th>
<th scope="col" class="org-left">举例</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">GET</td>
<td class="org-left">是</td>
<td class="org-left">获取编号为 123 的资源</td>
</tr>

<tr>
<td class="org-left">DELETE</td>
<td class="org-left">是</td>
<td class="org-left">删除编号为 123 的资源</td>
</tr>

<tr>
<td class="org-left">POST</td>
<td class="org-left">否</td>
<td class="org-left">在目录 /texts 下创建一个资源</td>
</tr>

<tr>
<td class="org-left">PUT</td>
<td class="org-left">是</td>
<td class="org-left">更改或创建 /textx/123 的详情</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-org0066e38" class="outline-4">
<h4 id="org0066e38"><span class="section-number-4">7.2.2</span> 无状态服务与有状态服务</h4>
<div class="outline-text-4" id="text-7-2-2">
</div>
<ol class="org-ol">
<li><a id="org411736b"></a>小明是一个 web 开发者<br />
<div class="outline-text-5" id="text-7-2-2-1">
<p>
小明的朋友写了一个购物网站，邀请小明进行试用，小明输入用户名与密码进行登录
</p>

<p>
然后小明想查看自己的购物车，发现又要进行登录，不仅如此每一次请求都要进行登录
</p>

<p>
小明脑子里有一个大大的问号
</p>
</div>
</li>

<li><a id="org9cdfd75"></a>你知道这个世界上有一个东西叫做 session 吗<br />
<div class="outline-text-5" id="text-7-2-2-2">

<div class="figure">
<p><img src="./images/user-server.png" alt="user-server.png" />
</p>
</div>

<p>
用户每次登录都会在服务器端保留一个 session 记录，用于后续的验证身份
</p>
</div>
</li>

<li><a id="org5f76d6c"></a>我的服务器撑不住了<br />
<div class="outline-text-5" id="text-7-2-2-3">
<p>
由于用户越来越多，一台机器无法保存过多的 session，于是小明的朋友增加了两台服务器然后在服务器间进行 session 的同步
</p>


<div class="figure">
<p><img src="images/multi-session.png" alt="multi-session.png" />
</p>
</div>
</div>
</li>

<li><a id="org3669452"></a>请使用万兆网络 + SSD<br />
<div class="outline-text-5" id="text-7-2-2-4">
<p>
小明的朋友发现了许多问题
</p>

<p>
1.多个服务之间的 session 同步造成了数据冗余，同时会消耗带宽
</p>

<p>
2.如何保证 session 同步的快速与准确
</p>

<p>
小明的朋友甚至考虑上一套 TIDB
</p>

<p>
可惜没有万兆网络与 SSD 无奈之下放弃了这套方案转而向小明求助
</p>
</div>
</li>
<li><a id="org63151c3"></a>你听说过烘焙吗<br />
<div class="outline-text-5" id="text-7-2-2-5">
<p>
小明给朋友提出了一个更加靠谱的方案
</p>

<p>
cookie + session
</p>


<div class="figure">
<p><img src="images/cookie-session.png" alt="cookie-session.png" />
</p>
</div>

<p>
1.用户第一进行登录时会在服务器端生成一个 session 然后设置一个过期时间, 同时给客户端创建一个加密后的 cookie
</p>

<p>
2.之后用户登录，会在请求头带上 cookie 的相关信息将请求发送到应用服务器
</p>

<p>
3.应用服务器进行接密后，然后进行校验后进行下一步操作
</p>
</div>
</li>
</ol>
</div>
</div>
<div id="outline-container-org55173c7" class="outline-3">
<h3 id="org55173c7"><span class="section-number-3">7.3</span> StatefulSet (sts)</h3>
<div class="outline-text-3" id="text-7-3">
<p>
StatefulSet 是 kubernetes 中为了管理有状态的服务而设计出的一种资源
</p>
</div>
<div id="outline-container-orgef87afd" class="outline-4">
<h4 id="orgef87afd"><span class="section-number-4">7.3.1</span> 特点</h4>
<div class="outline-text-4" id="text-7-3-1">
<p>
StatefulSet 所管理的 pod 拥有固定的名字 同时会按照顺序启动
</p>

<p>
在与 service 产生交互时，使用的是 healess service
</p>

<p>
直接将 pod name 注册到 dns server，没有负载均衡
</p>
</div>
</div>
<div id="outline-container-org8305a86" class="outline-4">
<h4 id="org8305a86"><span class="section-number-4">7.3.2</span> 场景</h4>
<div class="outline-text-4" id="text-7-3-2">
<p>
1.固定 POD IP
2.需要绑定存储
3.有序的扩展
4.有序的滚动升级
</p>
</div>
</div>
<div id="outline-container-orgb250e19" class="outline-4">
<h4 id="orgb250e19"><span class="section-number-4">7.3.3</span> example</h4>
<div class="outline-text-4" id="text-7-3-3">
<p>
microk8s 需要启动 storage
</p>
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #e7c547;">apiVersion</span>: storage.k8s.io/v1
<span style="color: #e7c547;">kind</span>: StorageClass
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">name</span>: local-storage
<span style="color: #e7c547;">provisioner</span>: kubernetes.io/no-provisioner
<span style="color: #e7c547;">volumeBindingMode</span>: WaitForFirstConsumer
<span style="color: #969896; font-style: italic;">---</span>
<span style="color: #e7c547;">apiVersion</span>: v1
<span style="color: #e7c547;">kind</span>: PersistentVolume
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">name</span>: local-pv
<span style="color: #e7c547;">spec</span>:
  <span style="color: #e7c547;">capacity</span>:
    <span style="color: #e7c547;">storage</span>: 10Gi
  <span style="color: #e7c547;">accessModes</span>:
  - ReadWriteOnce
  <span style="color: #e7c547;">persistentVolumeReclaimPolicy</span>: Retain
  <span style="color: #e7c547;">storageClassName</span>: local-storage
  <span style="color: #e7c547;">local</span>:
    <span style="color: #e7c547;">path</span>: /mnt/disk/vol1
  <span style="color: #e7c547;">nodeAffinity</span>:
    <span style="color: #e7c547;">required</span>:
      <span style="color: #e7c547;">nodeSelectorTerms</span>:
      - <span style="color: #e7c547;">matchExpressions</span>:
        - <span style="color: #e7c547;">key</span>: kubernetes.io/hostname
          <span style="color: #e7c547;">operator</span>: In
          <span style="color: #e7c547;">values</span>:
          - vagrant
<span style="color: #969896; font-style: italic;">---</span>
<span style="color: #e7c547;">apiVersion</span>: v1
<span style="color: #e7c547;">kind</span>: PersistentVolume
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">name</span>: local-pv-2
<span style="color: #e7c547;">spec</span>:
  <span style="color: #e7c547;">capacity</span>:
    <span style="color: #e7c547;">storage</span>: 10Gi
  <span style="color: #e7c547;">accessModes</span>:
  - ReadWriteOnce
  <span style="color: #e7c547;">persistentVolumeReclaimPolicy</span>: Retain
  <span style="color: #e7c547;">storageClassName</span>: local-storage
  <span style="color: #e7c547;">local</span>:
    <span style="color: #e7c547;">path</span>: /mnt/disk/vol2
  <span style="color: #e7c547;">nodeAffinity</span>:
    <span style="color: #e7c547;">required</span>:
      <span style="color: #e7c547;">nodeSelectorTerms</span>:
      - <span style="color: #e7c547;">matchExpressions</span>:
        - <span style="color: #e7c547;">key</span>: kubernetes.io/hostname
          <span style="color: #e7c547;">operator</span>: In
          <span style="color: #e7c547;">values</span>:
          - vagrant

<span style="color: #969896; font-style: italic;">---</span>
<span style="color: #e7c547;">apiVersion</span>: v1
<span style="color: #e7c547;">kind</span>: Service
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">name</span>: nginx
  <span style="color: #e7c547;">labels</span>:
    <span style="color: #e7c547;">app</span>: nginx
<span style="color: #e7c547;">spec</span>:
  <span style="color: #e7c547;">ports</span>:
  - <span style="color: #e7c547;">port</span>: 80
    <span style="color: #e7c547;">name</span>: web
  <span style="color: #e7c547;">clusterIP</span>: None
  <span style="color: #e7c547;">selector</span>:
    <span style="color: #e7c547;">app</span>: nginx
<span style="color: #969896; font-style: italic;">---</span>
<span style="color: #e7c547;">apiVersion</span>: apps/v1
<span style="color: #e7c547;">kind</span>: StatefulSet
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">name</span>: web
<span style="color: #e7c547;">spec</span>:
  <span style="color: #e7c547;">serviceName</span>: <span style="color: #70c0b1;">"nginx"</span>
  <span style="color: #e7c547;">replicas</span>: 2
  <span style="color: #e7c547;">selector</span>:
    <span style="color: #e7c547;">matchLabels</span>:
      <span style="color: #e7c547;">app</span>: nginx
  <span style="color: #e7c547;">template</span>:
    <span style="color: #e7c547;">metadata</span>:
      <span style="color: #e7c547;">labels</span>:
        <span style="color: #e7c547;">app</span>: nginx
    <span style="color: #e7c547;">spec</span>:
      <span style="color: #e7c547;">containers</span>:
      - <span style="color: #e7c547;">name</span>: nginx
        <span style="color: #e7c547;">image</span>: nginx:latest
        <span style="color: #e7c547;">ports</span>:
        - <span style="color: #e7c547;">containerPort</span>: 80
          <span style="color: #e7c547;">name</span>: web
        <span style="color: #e7c547;">volumeMounts</span>:
        - <span style="color: #e7c547;">name</span>: www
          <span style="color: #e7c547;">mountPath</span>: /usr/share/nginx/html
  <span style="color: #e7c547;">volumeClaimTemplates</span>:
    - <span style="color: #e7c547;">metadata</span>:
        <span style="color: #e7c547;">name</span>: www
      <span style="color: #e7c547;">spec</span>:
        <span style="color: #e7c547;">accessModes</span>: [ <span style="color: #70c0b1;">"ReadWriteOnce"</span> ]
        <span style="color: #e7c547;">storageClassName</span>: local-storage
        <span style="color: #e7c547;">resources</span>:
          <span style="color: #e7c547;">requests</span>:
            <span style="color: #e7c547;">storage</span>: 1Gi
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org2114793" class="outline-3">
<h3 id="org2114793"><span class="section-number-3">7.4</span> Cloud-Native</h3>
<div class="outline-text-3" id="text-7-4">
</div>
<div id="outline-container-org78c9124" class="outline-4">
<h4 id="org78c9124"><span class="section-number-4">7.4.1</span> DevOps</h4>
<div class="outline-text-4" id="text-7-4-1">
<p>
DevOps是软件开发人员与IT运营部门之间的协作，其目标是不断交付可解决客户挑战的高质量软件。
</p>

<p>
它具有创造一种文化和环境的潜力，在该文化和环境中，可以快速，频繁且更一致地进行软件的构建，测试和发布。
</p>

<p>
在敏捷产品开发实践的支持下，持续交付意味着通过自动化将小批软件不断交付生产。
</p>

<p>
持续交付使发布变得迟钝而可靠，从而组织可以以更低的风险频繁交付，并更快地从最终用户那里获得反馈。
</p>
</div>
</div>
<div id="outline-container-org34b011a" class="outline-4">
<h4 id="org34b011a"><span class="section-number-4">7.4.2</span> Microservices</h4>
<div class="outline-text-4" id="text-7-4-2">
<p>
微服务是一种将应用程序开发为一组小服务的体系结构方法。每个服务都实现业务功能，在其自己的流程中运行并通过HTTP API或消息传递进行通信。
</p>

<p>
每个微服务都可以独立于应用程序中的其他服务进行部署，升级，扩展和重新启动，通常作为自动化系统的一部分，从而可以对实时应用程序进行频繁更新而不会影响最终客户
</p>
</div>
</div>
<div id="outline-container-org784c1be" class="outline-4">
<h4 id="org784c1be"><span class="section-number-4">7.4.3</span> Container</h4>
<div class="outline-text-4" id="text-7-4-3">
<p>
与标准虚拟机（VM）相比，容器提供了效率和速度。使用操作系统（OS）级虚拟化，单个OS实例可以动态地划分到一个或多个隔离的容器中，
</p>

<p>
每个容器具有唯一的可写文件系统和资源配额。在单个VM中创建和销毁容器的低开销以及高包装密度使容器成为部署单个微服务的理想计算工具
</p>
</div>
</div>
</div>
<div id="outline-container-orgc1f6629" class="outline-3">
<h3 id="orgc1f6629"><span class="section-number-3">7.5</span> 课后作业</h3>
<div class="outline-text-3" id="text-7-5">
<p>
1.部署 example 中的 yaml
2.查看每个 pod 的 hostname
</p>
<pre class="example">
for i in 0 1; do kubectl exec web-$i -- sh -c 'hostname'; done
</pre>
<p>
3.启动一个新的 deploy 在新启动的 pod 内部查看 dns 记录并对比相应的 sts pod 的信息
</p>
<pre class="example">
nslookup web-1.nginx
</pre>
<p>
4.将副本数改为 0, pod 在销毁时是否有顺序?
</p>
</div>
</div>
</div>
<div id="outline-container-orgf110da8" class="outline-2">
<h2 id="orgf110da8"><span class="section-number-2">8</span> Service Loadbalanceing and Networking <span class="timestamp-wrapper"><span class="timestamp">&lt;2020-01-10 Fri&gt; </span></span> <span class="timestamp-wrapper"><span class="timestamp">&lt;2020-01-17 Fri&gt;</span></span></h2>
<div class="outline-text-2" id="text-8">
</div>
<div id="outline-container-org8cc255c" class="outline-3">
<h3 id="org8cc255c"><span class="section-number-3">8.1</span> 课程大纲</h3>
<div class="outline-text-3" id="text-8-1">
<ul class="org-ul">
<li class="off"><code>[&#xa0;]</code> 了解 kubernetes service 的相关概念</li>
<li class="off"><code>[&#xa0;]</code> 了解 ingress 的相关概念</li>
<li class="off"><code>[&#xa0;]</code> 简单了解 kubernetes 中的 dns</li>
</ul>
</div>
</div>
<div id="outline-container-org471f04c" class="outline-3">
<h3 id="org471f04c"><span class="section-number-3">8.2</span> 为什么在 kubernetes 中需要 service</h3>
<div class="outline-text-3" id="text-8-2">
</div>
<div id="outline-container-orgb1a0e43" class="outline-4">
<h4 id="orgb1a0e43"><span class="section-number-4">8.2.1</span> 今天不说小明的故事，今天来讲一个工具人的故事</h4>
<div class="outline-text-4" id="text-8-2-1">
<p>
工具人有几个很重要的特点:
1.用完就扔
</p>

<p>
2.有事情才来看看你，没事情从来不看你
</p>

<p>
3.随叫随到
</p>

<p>
4.可替代性很强
</p>
</div>
</div>
<div id="outline-container-org17ed366" class="outline-4">
<h4 id="org17ed366"><span class="section-number-4">8.2.2</span> Pod: 正是在下</h4>
<div class="outline-text-4" id="text-8-2-2">
<p>
Pod 具有工具人的绝大部分的特点，但是 Pod 有很大的问题，在通常情况下 pod 每次重新启动后，
</p>

<p>
Pod 的 IP 会发生变化，在除了 statefulset 管理的 pod，名字也会发生改变
</p>

<p>
这样就有一点不舒服了，一个工具人还想让我每次再找一遍？
</p>
</div>
</div>

<div id="outline-container-org2e51ddb" class="outline-4">
<h4 id="org2e51ddb"><span class="section-number-4">8.2.3</span> 如何找到合适的工具人</h4>
<div class="outline-text-4" id="text-8-2-3">
<p>
service 就是用来找工具人的一种绝佳方式
</p>

<p>
kubernetes 中有几种办法可以连通 pod 而不关心 pod 是否被重启过
</p>

<p>
1.通过 service 进行访问
</p>

<p>
2.直接通过 Dns 进行访问 (headless service)
</p>

<p>
3.固定 Pod ip
</p>
</div>
</div>
</div>

<div id="outline-container-orge061d9c" class="outline-3">
<h3 id="orge061d9c"><span class="section-number-3">8.3</span> Service 如何找到 pod 的</h3>
<div class="outline-text-3" id="text-8-3">
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #e7c547;">apiVersion</span>: apps/v1
<span style="color: #e7c547;">kind</span>: Deployment
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">name</span>: my-nginx
<span style="color: #e7c547;">spec</span>:
  <span style="color: #e7c547;">selector</span>:
    <span style="color: #e7c547;">matchLabels</span>:
      <span style="color: #e7c547;">run</span>: my-nginx
  <span style="color: #e7c547;">replicas</span>: 2
  <span style="color: #e7c547;">template</span>:
    <span style="color: #e7c547;">metadata</span>:
      <span style="color: #e7c547;">labels</span>:
        <span style="color: #e7c547;">run</span>: my-nginx
    <span style="color: #e7c547;">spec</span>:
      <span style="color: #e7c547;">containers</span>:
      - <span style="color: #e7c547;">name</span>: my-nginx
        <span style="color: #e7c547;">image</span>: nginx
        <span style="color: #e7c547;">ports</span>:
        - <span style="color: #e7c547;">containerPort</span>: 80

<span style="color: #969896; font-style: italic;">---</span>
<span style="color: #e7c547;">apiVersion</span>: v1
<span style="color: #e7c547;">kind</span>: Service
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">name</span>: my-nginx
  <span style="color: #e7c547;">labels</span>:
    <span style="color: #e7c547;">run</span>: my-nginx
<span style="color: #e7c547;">spec</span>:
  <span style="color: #e7c547;">type</span>: ClusterIP
  <span style="color: #e7c547;">ports</span>:
  - <span style="color: #e7c547;">port</span>: 30010
    <span style="color: #e7c547;">targetPort</span>: 80
    <span style="color: #e7c547;">protocol</span>: TCP
  <span style="color: #e7c547;">selector</span>:
    <span style="color: #e7c547;">run</span>: my-nginx
</pre>
</div>

<p>
通过 selector, 与其他的资源一样, service 也是通过 selector 与 label 的方式连接到 pod 上
</p>

<p>
service 也可以连接到非 pod 的其他资源上,这种情况下是不会创建 endpoint 的
</p>
</div>

<div id="outline-container-org2a67a01" class="outline-4">
<h4 id="org2a67a01"><span class="section-number-4">8.3.1</span> endpoint 与 Endpoint slices</h4>
<div class="outline-text-4" id="text-8-3-1">
</div>
<ol class="org-ol">
<li><a id="orgc64b725"></a>endpoint<br />
<div class="outline-text-5" id="text-8-3-1-1">
<p>
endpoint 中保存了 pod 的 ip 端口,所在机器, namespace 的信息
</p>

<p>
可以说 endpoint 的才是实际上对 pod 的网络信息进行记录与及时更改的资源
</p>

<p>
而 service 则是对 kubernetes 网络连接的抽象
</p>

<div class="org-src-container">
<pre class="src src-shell">kubectl get ep
</pre>
</div>

<p>
在这里你可以发现 service 与 endpoint 的是一一对应的,那么他们是怎么进行关联的?
</p>
</div>
</li>
<li><a id="orgad51c2a"></a>endpoint slices<br />
<div class="outline-text-5" id="text-8-3-1-2">
<p>
endpoint slices 是 1.17 中新加入的特性
</p>

<p>
他在概念上与 endpoint 非常的像, 他的存在是给 endpoint 提供更多的扩展选项
</p>

<p>
endpointslice 将所有满足 selector 标签的 endpoint 组合起来,更方便进行管理
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #e7c547;">apiVersion</span>: discovery.k8s.io/v1beta1
<span style="color: #e7c547;">kind</span>: EndpointSlice
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">name</span>: example-abc
  <span style="color: #e7c547;">labels</span>:
    <span style="color: #e7c547;">kubernetes.io/service-name</span>: example
<span style="color: #e7c547;">addressType</span>: IPv4
<span style="color: #e7c547;">ports</span>:
  - <span style="color: #e7c547;">name</span>: http
    <span style="color: #e7c547;">protocol</span>: TCP
    <span style="color: #e7c547;">port</span>: 80
<span style="color: #e7c547;">endpoints</span>:
  - <span style="color: #e7c547;">addresses</span>:
    - <span style="color: #70c0b1;">"10.1.2.3"</span>
    <span style="color: #e7c547;">conditions</span>:
      <span style="color: #e7c547;">ready</span>: <span style="color: #7aa6da;">true</span>
    <span style="color: #e7c547;">hostname</span>: pod-1
    <span style="color: #e7c547;">topology</span>:
      <span style="color: #e7c547;">kubernetes.io/hostname</span>: node-1
      <span style="color: #e7c547;">topology.kubernetes.io/zone</span>: us-west2-a
</pre>
</div>
</div>
</li>
</ol>
</div>
</div>

<div id="outline-container-org931be80" class="outline-3">
<h3 id="org931be80"><span class="section-number-3">8.4</span> Service 的几种类型</h3>
<div class="outline-text-3" id="text-8-4">
</div>
<div id="outline-container-orgb924a11" class="outline-4">
<h4 id="orgb924a11"><span class="section-number-4">8.4.1</span> ClusterIP</h4>
<div class="outline-text-4" id="text-8-4-1">
<p>
ClusterIP 是默认的类型，仅能在集群内部进行访问
</p>

<p>
ClusterIP 的几种实现方式会在之后将 kube-proxy 原理时将
</p>

<p>
在集群内部可以通过 clusterip:port 访问服务
</p>
<div class="org-src-container">
<pre class="src src-shell">curl clusterip:port
</pre>
</div>
</div>
</div>
<div id="outline-container-orgcd43639" class="outline-4">
<h4 id="orgcd43639"><span class="section-number-4">8.4.2</span> NodePort</h4>
<div class="outline-text-4" id="text-8-4-2">
<p>
Nodeport 的方式是使用机器的固定端口,如果集群内有多个机器,那么要求所有机器上的这个端口都没有被占用
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #e7c547;">apiVersion</span>: v1
<span style="color: #e7c547;">kind</span>: Service
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">name</span>: my-nginx-node-port
  <span style="color: #e7c547;">labels</span>:
    <span style="color: #e7c547;">run</span>: my-nginx
<span style="color: #e7c547;">spec</span>:
  <span style="color: #e7c547;">type</span>: NodePort
  <span style="color: #e7c547;">ports</span>:
  - <span style="color: #e7c547;">port</span>: 30010
    <span style="color: #e7c547;">nodePort</span>: 30010
    <span style="color: #e7c547;">targetPort</span>: 80
    <span style="color: #e7c547;">protocol</span>: TCP
  <span style="color: #e7c547;">selector</span>:
    <span style="color: #e7c547;">run</span>: my-nginx
</pre>
</div>

<p>
Nodeport 是 ClusterIP 的一种扩展,NodePort 会自动的创建一个 ClusterIP
</p>

<p>
同时也可以使用这个 ClusterIP 进行访问
</p>
</div>
</div>
<div id="outline-container-org57eb43d" class="outline-4">
<h4 id="org57eb43d"><span class="section-number-4">8.4.3</span> LoadBalancer</h4>
<div class="outline-text-4" id="text-8-4-3">
<p>
LoadBalancer 模式的 service 较为特殊会在之后将 ccm 的时候将
</p>
</div>
</div>
<div id="outline-container-orga83e486" class="outline-4">
<h4 id="orga83e486"><span class="section-number-4">8.4.4</span> ExternalName</h4>
<div class="outline-text-4" id="text-8-4-4">
<p>
ExternalName 类型的 Service 为外部 DNS 名称提供内部别名。
</p>

<p>
内部客户端使用内部 DNS 名称发出请求，然后请求会被重定向到外部名称
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #e7c547;">apiVersion</span>: v1
<span style="color: #e7c547;">kind</span>: Service
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">name</span>: my-xn-service
<span style="color: #e7c547;">spec</span>:
  <span style="color: #e7c547;">type</span>: ExternalName
  <span style="color: #e7c547;">externalName</span>: example.com
</pre>
</div>

<p>
创建 Service 时，Kubernetes 会创建一个 DNS 名称，内部客户端可以使用该名称来调用 Service。
</p>

<p>
对于上述示例，DNS 名称是 my-xn-service.default.svc.cluster.local。
</p>

<p>
当内部客户端向 my-xn-service.default.svc.cluster.local 发出请求时，请求会被重定向到 example.com。
</p>

<p>
ExternalName Service 类型与其他 Service 类型完全不同。
</p>

<p>
ExternalName 类型的 Service 不与一组 Pod 相关联，也没有稳定的 IP 地址。
</p>

<p>
相反，ExternalName 类型的 Service 从内部 DNS 名称映射到外部 DNS 名称。
</p>
</div>
</div>
<div id="outline-container-orgbf14d40" class="outline-4">
<h4 id="orgbf14d40"><span class="section-number-4">8.4.5</span> Headless</h4>
<div class="outline-text-4" id="text-8-4-5">
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #e7c547;">apiVersion</span>: v1
<span style="color: #e7c547;">kind</span>: Service
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">name</span>: nginx
  <span style="color: #e7c547;">labels</span>:
    <span style="color: #e7c547;">app</span>: nginx
<span style="color: #e7c547;">spec</span>:
  <span style="color: #e7c547;">ports</span>:
  - <span style="color: #e7c547;">port</span>: 80
    <span style="color: #e7c547;">name</span>: web
  <span style="color: #e7c547;">clusterIP</span>: None
  <span style="color: #e7c547;">selector</span>:
    <span style="color: #e7c547;">app</span>: nginx
</pre>
</div>
<p>
在无状态时将的 headless 的访问模式,如果现式的指定 clusterIP 为 None
</p>

<p>
那他将是一个 Headless 的服务
</p>

<p>
Headless 使用的是在 statefulset 中的使用方式相同
</p>
</div>
</div>
</div>

<div id="outline-container-org7606c37" class="outline-3">
<h3 id="org7606c37"><span class="section-number-3">8.5</span> Ingress 与 Ingress controller</h3>
<div class="outline-text-3" id="text-8-5">
<p>
ingress 是用来打通外界网络到内部 service 的
</p>


<div class="figure">
<p><img src="./images/ingress.png" alt="ingress.png" />
</p>
</div>

<p>
如果说 service 管理的是四层的流量,那么 ingress 管理的则是七层的流量
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #e7c547;">apiVersion</span>: extensions/v1beta1
<span style="color: #e7c547;">kind</span>: Ingress
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">name</span>: my-ingress
  <span style="color: #e7c547;">annotations</span>:
    <span style="color: #e7c547;">nginx.ingress.kubernetes.io/use-regex</span>: <span style="color: #70c0b1;">"true"</span>
<span style="color: #e7c547;">spec</span>:
  <span style="color: #e7c547;">rules</span>:
  - <span style="color: #e7c547;">host</span>: api.mydomain.com
    <span style="color: #e7c547;">http</span>:
      <span style="color: #e7c547;">paths</span>:
      - <span style="color: #e7c547;">backend</span>:
          <span style="color: #e7c547;">serviceName</span>: api
          <span style="color: #e7c547;">servicePort</span>: 80
  - <span style="color: #e7c547;">host</span>: domain.com
    <span style="color: #e7c547;">http</span>:
      <span style="color: #e7c547;">paths</span>:
      - <span style="color: #e7c547;">path</span>: /web/*
        <span style="color: #e7c547;">backend</span>:
          <span style="color: #e7c547;">serviceName</span>: web
          <span style="color: #e7c547;">servicePort</span>: 8080
  - <span style="color: #e7c547;">host</span>: backoffice.domain.com
    <span style="color: #e7c547;">http</span>:
      <span style="color: #e7c547;">paths</span>:
      - <span style="color: #e7c547;">backend</span>:
          <span style="color: #e7c547;">serviceName</span>: backoffice
          <span style="color: #e7c547;">servicePort</span>: 8080
</pre>
</div>

<p>
ingress 这种资源依赖于外界的 ingress controller 实现
</p>

<p>
如果你没有启用任何的 ingress controller 那么你即使访问了相应的 URL 也没有作用
</p>

<p>
可以在 <a href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/">https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/</a> 这里找到主流的 ingress controller
</p>

<p>
最常使用的是 ingress-nginx
</p>

<p>
简单的介绍一下实现原理
</p>

<p>
0.当集群中部署了 ingress-nginx 之后
</p>

<p>
1.当用户创建了一个 ingress 资源,会被 ingress-nginx 监听到
</p>

<p>
2.nginx-ingress 会写入 nginx 的规则并进行 reload
</p>

<p>
3.如果需要启动 TLS 需要自己生成证书然后将证书写入到 ingress-nginx 的配置当中
</p>
</div>
</div>
<div id="outline-container-orgd4d7125" class="outline-3">
<h3 id="orgd4d7125"><span class="section-number-3">8.6</span> Network policies</h3>
<div class="outline-text-3" id="text-8-6">
<p>
network pilicy 用来帮助 pod 隔离流量
</p>

<p>
简单的理解为给 pod 建立一个白名单
</p>
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #e7c547;">apiVersion</span>: networking.k8s.io/v1
<span style="color: #e7c547;">kind</span>: NetworkPolicy
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">name</span>: test-network-policy
  <span style="color: #e7c547;">namespace</span>: default
<span style="color: #e7c547;">spec</span>:
  <span style="color: #e7c547;">podSelector</span>:
    <span style="color: #e7c547;">matchLabels</span>:
      <span style="color: #e7c547;">role</span>: db
  <span style="color: #e7c547;">policyTypes</span>:
  - Ingress
  - Egress
  <span style="color: #e7c547;">ingress</span>:
  - <span style="color: #e7c547;">from</span>:
    - <span style="color: #e7c547;">ipBlock</span>:
        <span style="color: #e7c547;">cidr</span>: 172.17.0.0/16
        <span style="color: #e7c547;">except</span>:
        - 172.17.1.0/24
    - <span style="color: #e7c547;">namespaceSelector</span>:
        <span style="color: #e7c547;">matchLabels</span>:
          <span style="color: #e7c547;">project</span>: myproject
    - <span style="color: #e7c547;">podSelector</span>:
        <span style="color: #e7c547;">matchLabels</span>:
          <span style="color: #e7c547;">role</span>: frontend
    <span style="color: #e7c547;">ports</span>:
    - <span style="color: #e7c547;">protocol</span>: TCP
      <span style="color: #e7c547;">port</span>: 6379
  <span style="color: #e7c547;">egress</span>:
  - <span style="color: #e7c547;">to</span>:
  - <span style="color: #e7c547;">ipBlock</span>:
        <span style="color: #e7c547;">cidr</span>: 10.0.0.0/24
    <span style="color: #e7c547;">ports</span>:
    - <span style="color: #e7c547;">protocol</span>: TCP
      <span style="color: #e7c547;">port</span>: 5978
</pre>
</div>

<p>
流量控制支持 SCTP (Stream Control Transmission Protocol): 需要额外开启 &#x2013;feature-gates=SCTPSupport=true
</p>
</div>
</div>
<div id="outline-container-org0025b7b" class="outline-3">
<h3 id="org0025b7b"><span class="section-number-3">8.7</span> IPv4/IPv6</h3>
<div class="outline-text-3" id="text-8-7">
<p>
IPv6 的支持需要在 kubelet  kube-controller  kube-proxy 开启相关参数
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #e7c547;">apiVersion</span>: v1
<span style="color: #e7c547;">kind</span>: Service
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">name</span>: my-service
<span style="color: #e7c547;">spec</span>:
  <span style="color: #e7c547;">ipFamily</span>: IPv6
  <span style="color: #e7c547;">selector</span>:
    <span style="color: #e7c547;">app</span>: MyApp
  <span style="color: #e7c547;">ports</span>:
    - <span style="color: #e7c547;">protocol</span>: TCP
      <span style="color: #e7c547;">port</span>: 80
      <span style="color: #e7c547;">targetPort</span>: 9376
</pre>
</div>

<p>
然后指定 ipFamily 后进行 IPv6 的分配
</p>

<p>
IPv4 与 IPv6 的比较可以看
</p>

<p>
<a href="https://www.ibm.com/support/knowledgecenter/zh/ssw_ibm_i_72/rzai2/rzai2compipv4ipv6.htm">https://www.ibm.com/support/knowledgecenter/zh/ssw_ibm_i_72/rzai2/rzai2compipv4ipv6.htm</a>
</p>
</div>
</div>
<div id="outline-container-org740fb37" class="outline-3">
<h3 id="org740fb37"><span class="section-number-3">8.8</span> 课后作业</h3>
<div class="outline-text-3" id="text-8-8">
<p>
1.创建一个 clusterIP 的 service，指向一个 nginx 和一个 2048
</p>

<p>
2.集群内访问这个 service,会发生什么
</p>

<p>
3.将这个 service 的类型改为 NodePort 并使用 40010 端口
</p>

<p>
4.从集群外通过 node:port 的方式访问这个 service
</p>

<p>
5.启用 nginx ingress 并且创建一个 ingress 资源代理上一步的 service;域名为 api.mydomain.com
</p>

<p>
6.修改 HTTP 的 HOST 头或者修改 /etc/hosts 文件后访问 api.mydomain.com
</p>
</div>
</div>
</div>
<div id="outline-container-org49a3706" class="outline-2">
<h2 id="org49a3706"><span class="section-number-2">9</span> Storage <span class="timestamp-wrapper"><span class="timestamp">&lt;2020-03-23 Mon&gt;</span></span></h2>
<div class="outline-text-2" id="text-9">
</div>
<div id="outline-container-orgd8d4e07" class="outline-3">
<h3 id="orgd8d4e07"><span class="section-number-3">9.1</span> 课程大纲</h3>
<div class="outline-text-3" id="text-9-1">
<ul class="org-ul">
<li class="off"><code>[&#xa0;]</code> 了解 pv pvc Storage Class 的相关概念</li>
<li class="off"><code>[&#xa0;]</code> 了解 CSI 的相关概念</li>
</ul>
</div>
</div>
<div id="outline-container-org50c25e1" class="outline-3">
<h3 id="org50c25e1"><span class="section-number-3">9.2</span> 从删库跑路到数据恢复</h3>
<div class="outline-text-3" id="text-9-2">
</div>
<div id="outline-container-orgb4328ac" class="outline-4">
<h4 id="orgb4328ac"><span class="section-number-4">9.2.1</span> 数据的保存</h4>
<div class="outline-text-4" id="text-9-2-1">
<p>
从 3.5 英寸的软盘到机械硬盘再到 SSD,存储技术不断的在追求速度的进步
</p>

<p>
那是否思考过一个问题，为什么存储一直试图在速度上寻找突破？
</p>

<p>
因为它生来就是为了持久化的保存数据
</p>

<p>
持久化的保存数据就面临着一个重要的问题，数据丢了怎么办？
</p>

<p>
甲: 一块硬盘坏了
</p>

<p>
乙: 做RAID
</p>

<p>
甲: RAID 卡断电了
</p>

<p>
乙: 多组 RAID 保存
</p>

<p>
甲: 机房炸了
</p>

<p>
乙: 两地三中心的部署方案
</p>

<p>
甲: 世界大战导致城市消失
</p>

<p>
乙: 把数据存到胶卷中，然后在北极挖个矿井
</p>

<p>
甲: 地球毁灭了
</p>

<p>
乙: 发个卫星存到轨道站
</p>

<p>
乙: 地球都毁灭了，你还要这些数据干嘛
</p>
</div>
</div>
<div id="outline-container-orgf4f2959" class="outline-4">
<h4 id="orgf4f2959"><span class="section-number-4">9.2.2</span> 给容器用的存储方案</h4>
<div class="outline-text-4" id="text-9-2-2">
<p>
就像我们之前将过的，容器本质上是一个进程，他没有自己的文件系统，自然无法存储数据
</p>

<p>
而且容器声明周期并不会很长，同时还有很强的流动性
</p>

<p>
那么动态的分配存储与文件持久化就成了容器存储要考虑的问题
</p>
</div>
</div>
</div>
<div id="outline-container-orgb660894" class="outline-3">
<h3 id="orgb660894"><span class="section-number-3">9.3</span> Volumes</h3>
<div class="outline-text-3" id="text-9-3">
</div>
<div id="outline-container-org7586e9d" class="outline-4">
<h4 id="org7586e9d"><span class="section-number-4">9.3.1</span> kubernetes 支持的存储卷</h4>
<div class="outline-text-4" id="text-9-3-1">
<p>
kubernetes 支持多种存储卷,下面举几个常用的例子
1.local
</p>
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #e7c547;">apiVersion</span>: v1
<span style="color: #e7c547;">kind</span>: PersistentVolume
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">name</span>: example-pv
<span style="color: #e7c547;">spec</span>:
  <span style="color: #e7c547;">capacity</span>:
    <span style="color: #e7c547;">storage</span>: 100Gi
  <span style="color: #e7c547;">volumeMode</span>: Filesystem
  <span style="color: #e7c547;">accessModes</span>:
  - ReadWriteOnce
  <span style="color: #e7c547;">persistentVolumeReclaimPolicy</span>: Delete
  <span style="color: #e7c547;">storageClassName</span>: local-storage
  <span style="color: #e7c547;">local</span>:
    <span style="color: #e7c547;">path</span>: /mnt/disks/ssd1
  <span style="color: #e7c547;">nodeAffinity</span>:
    <span style="color: #e7c547;">required</span>:
      <span style="color: #e7c547;">nodeSelectorTerms</span>:
      - <span style="color: #e7c547;">matchExpressions</span>:
        - <span style="color: #e7c547;">key</span>: kubernetes.io/hostname
          <span style="color: #e7c547;">operator</span>: In
          <span style="color: #e7c547;">values</span>:
          - example-node
</pre>
</div>
<p>
2.nfs
</p>
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #e7c547;">apiVersion</span>: v1
<span style="color: #e7c547;">kind</span>: PersistentVolume
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">name</span>: nfs
<span style="color: #e7c547;">spec</span>:
  <span style="color: #e7c547;">capacity</span>:
    <span style="color: #e7c547;">storage</span>: 1Mi
  <span style="color: #e7c547;">accessModes</span>:
    - ReadWriteMany
  <span style="color: #e7c547;">nfs</span>:
    <span style="color: #e7c547;">server</span>: nfs-server.default.svc.cluster.local
    <span style="color: #e7c547;">path</span>: <span style="color: #70c0b1;">"/"</span>
</pre>
</div>
<p>
3.awsElasticBlockStore
</p>
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #e7c547;">apiVersion</span>: v1
<span style="color: #e7c547;">kind</span>: Pod
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">name</span>: test-ebs
<span style="color: #e7c547;">spec</span>:
  <span style="color: #e7c547;">containers</span>:
  - <span style="color: #e7c547;">image</span>: k8s.gcr.io/test-webserver
    <span style="color: #e7c547;">name</span>: test-container
    <span style="color: #e7c547;">volumeMounts</span>:
    - <span style="color: #e7c547;">mountPath</span>: /test-ebs
      <span style="color: #e7c547;">name</span>: test-volume
  <span style="color: #e7c547;">volumes</span>:
  - <span style="color: #e7c547;">name</span>: test-volume
    <span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">This AWS EBS volume must already exist.</span>
    <span style="color: #e7c547;">awsElasticBlockStore</span>:
      <span style="color: #e7c547;">volumeID</span>: &lt;volume-id&gt;
      <span style="color: #e7c547;">fsType</span>: ext4
</pre>
</div>
</div>
</div>
<div id="outline-container-org60ef2f3" class="outline-4">
<h4 id="org60ef2f3"><span class="section-number-4">9.3.2</span> CSI</h4>
<div class="outline-text-4" id="text-9-3-2">
<p>
Container Storage Interface 容器存储接口, 通过 CSI 可以定义自己的一个存储驱动
</p>
<div class="org-src-container">
<pre class="src src-grpc">service Identity {
  rpc GetPluginInfo(GetPluginInfoRequest)
    returns (GetPluginInfoResponse) {}

  rpc GetPluginCapabilities(GetPluginCapabilitiesRequest)
    returns (GetPluginCapabilitiesResponse) {}

  rpc Probe (ProbeRequest)
    returns (ProbeResponse) {}
}

service Controller {
  rpc CreateVolume (CreateVolumeRequest)
    returns (CreateVolumeResponse) {}

  rpc DeleteVolume (DeleteVolumeRequest)
    returns (DeleteVolumeResponse) {}

  rpc ControllerPublishVolume (ControllerPublishVolumeRequest)
    returns (ControllerPublishVolumeResponse) {}

  rpc ControllerUnpublishVolume (ControllerUnpublishVolumeRequest)
    returns (ControllerUnpublishVolumeResponse) {}

  rpc ValidateVolumeCapabilities (ValidateVolumeCapabilitiesRequest)
    returns (ValidateVolumeCapabilitiesResponse) {}

  rpc ListVolumes (ListVolumesRequest)
    returns (ListVolumesResponse) {}

  rpc GetCapacity (GetCapacityRequest)
    returns (GetCapacityResponse) {}

  rpc ControllerGetCapabilities (ControllerGetCapabilitiesRequest)
    returns (ControllerGetCapabilitiesResponse) {}

  rpc CreateSnapshot (CreateSnapshotRequest)
    returns (CreateSnapshotResponse) {}

  rpc DeleteSnapshot (DeleteSnapshotRequest)
    returns (DeleteSnapshotResponse) {}

  rpc ListSnapshots (ListSnapshotsRequest)
    returns (ListSnapshotsResponse) {}

  rpc ControllerExpandVolume (ControllerExpandVolumeRequest)
    returns (ControllerExpandVolumeResponse) {}
}

service Node {
  rpc NodeStageVolume (NodeStageVolumeRequest)
    returns (NodeStageVolumeResponse) {}

  rpc NodeUnstageVolume (NodeUnstageVolumeRequest)
    returns (NodeUnstageVolumeResponse) {}

  rpc NodePublishVolume (NodePublishVolumeRequest)
    returns (NodePublishVolumeResponse) {}

  rpc NodeUnpublishVolume (NodeUnpublishVolumeRequest)
    returns (NodeUnpublishVolumeResponse) {}

  rpc NodeGetVolumeStats (NodeGetVolumeStatsRequest)
    returns (NodeGetVolumeStatsResponse) {}


  rpc NodeExpandVolume(NodeExpandVolumeRequest)
    returns (NodeExpandVolumeResponse) {}


  rpc NodeGetCapabilities (NodeGetCapabilitiesRequest)
    returns (NodeGetCapabilitiesResponse) {}

  rpc NodeGetInfo (NodeGetInfoRequest)
    returns (NodeGetInfoResponse) {}
}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org19cd78f" class="outline-3">
<h3 id="org19cd78f"><span class="section-number-3">9.4</span> PV PVC and Storage Class</h3>
<div class="outline-text-3" id="text-9-4">
</div>
<div id="outline-container-orge6cf283" class="outline-4">
<h4 id="orge6cf283"><span class="section-number-4">9.4.1</span> PV PVC 的概念</h4>
<div class="outline-text-4" id="text-9-4-1">
<p>
PV 全名 PersistentVolume PVC 全名 PersistentVolumeClaim
</p>

<p>
PV 是 k8s 中用来管理集群中的存储资源,PV 的意义在于将存储的声明周期独立与 pod 的生命周期
</p>

<p>
PVC 是 k8s 中管理用户存储请求的资源，PVC 可以向 PV 请求特定的大小与访问模式
</p>
</div>
</div>
<div id="outline-container-org34ec5f7" class="outline-4">
<h4 id="org34ec5f7"><span class="section-number-4">9.4.2</span> 创建一个 PV 与 PVC</h4>
<div class="outline-text-4" id="text-9-4-2">
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #e7c547;">apiVersion</span>: v1
<span style="color: #e7c547;">kind</span>: PersistentVolume
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">name</span>: task-pv-volume
  <span style="color: #e7c547;">labels</span>:
    <span style="color: #e7c547;">type</span>: local
<span style="color: #e7c547;">spec</span>:
  <span style="color: #e7c547;">storageClassName</span>: manual
  <span style="color: #e7c547;">capacity</span>:
    <span style="color: #e7c547;">storage</span>: 10Gi
  <span style="color: #e7c547;">accessModes</span>:
    - ReadWriteOnce
  <span style="color: #e7c547;">persistentVolumeReclaimPolicy</span>: Retain
  <span style="color: #e7c547;">hostPath</span>:
    <span style="color: #e7c547;">path</span>: <span style="color: #70c0b1;">"/mnt/data"</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #e7c547;">apiVersion</span>: v1
<span style="color: #e7c547;">kind</span>: PersistentVolumeClaim
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">name</span>: task-pv-claim
<span style="color: #e7c547;">spec</span>:
  <span style="color: #e7c547;">storageClassName</span>: manual
  <span style="color: #e7c547;">accessModes</span>:
    - ReadWriteOnce
  <span style="color: #e7c547;">resources</span>:
    <span style="color: #e7c547;">requests</span>:
      <span style="color: #e7c547;">storage</span>: 3Gi
</pre>
</div>
</div>
</div>
<div id="outline-container-org6c0fff8" class="outline-4">
<h4 id="org6c0fff8"><span class="section-number-4">9.4.3</span> Storage Class</h4>
<div class="outline-text-4" id="text-9-4-3">
<p>
一个 PV 只能被一个 PVC 绑定,那么在有的场景下需要动态的创建 pvc 进行 pod 的绑定
1.事先创建好大量的 pv
2.使用 storage Class 进行动态的创建与绑定
</p>
</div>
</div>
<div id="outline-container-org1ebdf4f" class="outline-4">
<h4 id="org1ebdf4f"><span class="section-number-4">9.4.4</span> 创建一个 Storage Class</h4>
<div class="outline-text-4" id="text-9-4-4">
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #e7c547;">apiVersion</span>: storage.k8s.io/v1
<span style="color: #e7c547;">kind</span>: StorageClass
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">name</span>: local-storage
<span style="color: #e7c547;">provisioner</span>: kubernetes.io/no-provisioner
<span style="color: #e7c547;">volumeBindingMode</span>: WaitForFirstConsumer
</pre>
</div>

<div class="figure">
<p><img src="images/pv-pvc.png" alt="pv-pvc.png" />
</p>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-org6953374" class="outline-2">
<h2 id="org6953374"><span class="section-number-2">10</span> 最佳实践</h2>
<div class="outline-text-2" id="text-10">
</div>
<div id="outline-container-org87263b7" class="outline-3">
<h3 id="org87263b7"><span class="section-number-3">10.1</span> 如何最快的准备一个单节点 k8s 集群</h3>
<div class="outline-text-3" id="text-10-1">
</div>
<div id="outline-container-org7677d51" class="outline-4">
<h4 id="org7677d51"><span class="section-number-4">10.1.1</span> 前言</h4>
<div class="outline-text-4" id="text-10-1-1">
<p>
对于一个初学者来说将时间浪费在安装部署 k8s 集群上是一件十分不明智的事情
</p>

<p>
目前很方便安装 k8s 的方式有以下几种:
</p>

<p>
1.kubeadm
</p>

<p>
可以使用 kubeadm 直接进行安装，主要存在的问题是镜像，k8s 的镜像存在 gcr.io 的仓库
</p>

<p>
而我们伟大的防火长城阻止了国内用户以常规的方式进行访问
</p>

<p>
如果有人想尝试可以使用 <a href="https://github.com/ReigenAraka/tools.git">https://github.com/ReigenAraka/tools.git</a> 拉取镜像
</p>

<p>
2.vagrant + ansible
</p>

<p>
vagrant 是 hashcorp 出的一个通过配置文件启动虚拟机的一个工具
</p>

<p>
ansible 是一个在个虚拟机上同时进行操作的工具
</p>

<p>
这种方式安装 k8s 集群比较适合经验丰富的人，因为除了 k8s 的配置之外还要维护 vagrant 与 ansible 的配置文件
</p>

<p>
3.minikube
</p>

<p>
minikube 是一个运行单节点 k8s 集群的一种方式，简单轻量，唯一的缺点就是要使用虚拟机
</p>

<p>
如果使用想安装可以参考下面的文档
</p>

<p>
<a href="https://kubernetes.io/docs/tasks/tools/install-minikube/">https://kubernetes.io/docs/tasks/tools/install-minikube/</a>
</p>

<p>
4.microk8s
</p>

<p>
microk8s 是 ubuntu 出的一个以 service 代替传统的 docker container 启动 k8s 组件的一种方式
</p>

<p>
是目前我使用过最简单与轻量的安装方式
</p>
</div>
</div>

<div id="outline-container-orgb948036" class="outline-4">
<h4 id="orgb948036"><span class="section-number-4">10.1.2</span> 使用 microk8s 进行安装</h4>
<div class="outline-text-4" id="text-10-1-2">
<ul class="org-ul">
<li class="off"><code>[&#xa0;]</code> 使用最新的版本</li>
</ul>
<div class="org-src-container">
<pre class="src src-shell">sudo snap install microk8s --classic
</pre>
</div>
<ul class="org-ul">
<li class="off"><code>[&#xa0;]</code> 使用指定的版本</li>
</ul>
<div class="org-src-container">
<pre class="src src-shell">snap info microk8s
sudo snap install microk8s --classic --channel=1.17/stable
</pre>
</div>
</div>


<ol class="org-ol">
<li><a id="org5e28ee1"></a>简单的使用指南<br />
<div class="outline-text-5" id="text-10-1-2-1">
<p>
1.查看 microk8s 的状态
</p>
<pre class="example">
microk8s.status
</pre>

<p>
2.启用一个新的功能
</p>
<pre class="example">
microk8s.enable ***
</pre>

<p>
3.start/stop
</p>
<pre class="example">
microk8s.start/microk8s.stop
</pre>

<p>
4.kubectl
</p>
<pre class="example">
microk8s.kubectl
</pre>
</div>
</li>
</ol>
</div>
</div>
<div id="outline-container-org370f3b9" class="outline-3">
<h3 id="org370f3b9"><span class="section-number-3">10.2</span> 部署一个 wordpress</h3>
<div class="outline-text-3" id="text-10-2">
<p>
Wordppress 需要启动两个 pod, mysql 与 wordpress
<img src="./images/wordpress-mysql.jpeg" alt="wordpress-mysql.jpeg" />
</p>
</div>
<div id="outline-container-org079a1c7" class="outline-4">
<h4 id="org079a1c7"><span class="section-number-4">10.2.1</span> 创建 mysql 的相关资源</h4>
<div class="outline-text-4" id="text-10-2-1">
</div>
<ol class="org-ol">
<li><a id="org28b8e4b"></a>创建 StorageClass<br />
<div class="outline-text-5" id="text-10-2-1-1">
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #e7c547;">apiVersion</span>: storage.k8s.io/v1
<span style="color: #e7c547;">kind</span>: StorageClass
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">name</span>: mysql
<span style="color: #e7c547;">provisioner</span>: kubernetes.io/no-provisioner
<span style="color: #e7c547;">volumeBindingMode</span>: WaitForFirstConsumer
</pre>
</div>
</div>
</li>
<li><a id="org02a3bc1"></a>创建 service<br />
<div class="outline-text-5" id="text-10-2-1-2">
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #e7c547;">apiVersion</span>: v1
<span style="color: #e7c547;">kind</span>: Service
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">name</span>: wordpress-mysql
  <span style="color: #e7c547;">labels</span>:
    <span style="color: #e7c547;">app</span>: wordpress
<span style="color: #e7c547;">spec</span>:
  <span style="color: #e7c547;">ports</span>:
    - <span style="color: #e7c547;">port</span>: 3306
  <span style="color: #e7c547;">selector</span>:
    <span style="color: #e7c547;">app</span>: wordpress
    <span style="color: #e7c547;">tier</span>: mysql
</pre>
</div>
</div>
</li>
<li><a id="org901c6ee"></a>创建 PV<br />
<div class="outline-text-5" id="text-10-2-1-3">
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #e7c547;">apiVersion</span>: v1
<span style="color: #e7c547;">kind</span>: PersistentVolume
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">name</span>: wordpress-mysql
<span style="color: #e7c547;">spec</span>:
  <span style="color: #e7c547;">capacity</span>:
    <span style="color: #e7c547;">storage</span>: 20Gi
  <span style="color: #e7c547;">storageClassName</span>: mysql
  <span style="color: #e7c547;">accessModes</span>:
  - ReadWriteOnce
  <span style="color: #e7c547;">persistentVolumeReclaimPolicy</span>: Retain
  <span style="color: #e7c547;">local</span>:
    <span style="color: #e7c547;">path</span>: /mnt/lab/mysql
  <span style="color: #e7c547;">nodeAffinity</span>:
    <span style="color: #e7c547;">required</span>:
      <span style="color: #e7c547;">nodeSelectorTerms</span>:
      - <span style="color: #e7c547;">matchExpressions</span>:
        - <span style="color: #e7c547;">key</span>: kubernetes.io/hostname
          <span style="color: #e7c547;">operator</span>: In
          <span style="color: #e7c547;">values</span>:
          - vagrant
</pre>
</div>
</div>
</li>
<li><a id="org981d90a"></a>创建 PVC<br />
<div class="outline-text-5" id="text-10-2-1-4">
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #e7c547;">apiVersion</span>: v1
<span style="color: #e7c547;">kind</span>: PersistentVolumeClaim
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">name</span>: wordpress-mysql-pvc
  <span style="color: #e7c547;">labels</span>:
    <span style="color: #e7c547;">app</span>: wordpress
<span style="color: #e7c547;">spec</span>:
  <span style="color: #e7c547;">storageClassName</span>: mysql
  <span style="color: #e7c547;">accessModes</span>:
    - ReadWriteOnce
  <span style="color: #e7c547;">resources</span>:
    <span style="color: #e7c547;">requests</span>:
      <span style="color: #e7c547;">storage</span>: 30Gi
</pre>
</div>
</div>
</li>
<li><a id="org8280351"></a>创建 Mysql 的 deployment<br />
<div class="outline-text-5" id="text-10-2-1-5">
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #e7c547;">apiVersion</span>: apps/v1
<span style="color: #e7c547;">kind</span>: Deployment
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">name</span>: wordpress-mysql
  <span style="color: #e7c547;">labels</span>:
    <span style="color: #e7c547;">app</span>: wordpress
<span style="color: #e7c547;">spec</span>:
  <span style="color: #e7c547;">selector</span>:
    <span style="color: #e7c547;">matchLabels</span>:
      <span style="color: #e7c547;">app</span>: wordpress
      <span style="color: #e7c547;">tier</span>: mysql
  <span style="color: #e7c547;">strategy</span>:
    <span style="color: #e7c547;">type</span>: Recreate
  <span style="color: #e7c547;">template</span>:
    <span style="color: #e7c547;">metadata</span>:
      <span style="color: #e7c547;">labels</span>:
        <span style="color: #e7c547;">app</span>: wordpress
        <span style="color: #e7c547;">tier</span>: mysql
    <span style="color: #e7c547;">spec</span>:
      <span style="color: #e7c547;">containers</span>:
      - <span style="color: #e7c547;">image</span>: daocloud.io/library/mysql:5.6
        <span style="color: #e7c547;">name</span>: mysql
        <span style="color: #e7c547;">env</span>:
        - <span style="color: #e7c547;">name</span>: MYSQL_ROOT_PASSWORD
          <span style="color: #e7c547;">value</span>: thisisnotapassword
        <span style="color: #e7c547;">ports</span>:
        - <span style="color: #e7c547;">containerPort</span>: 3306
          <span style="color: #e7c547;">name</span>: mysql
        <span style="color: #e7c547;">volumeMounts</span>:
        - <span style="color: #e7c547;">name</span>: mysql-persistent-storage
          <span style="color: #e7c547;">mountPath</span>: /var/lib/mysql
      <span style="color: #e7c547;">volumes</span>:
      - <span style="color: #e7c547;">name</span>: mysql-persistent-storage
        <span style="color: #e7c547;">persistentVolumeClaim</span>:
          <span style="color: #e7c547;">claimName</span>: wordpress-mysql-pvc
</pre>
</div>
</div>
</li>
</ol>
</div>
<div id="outline-container-org5864f55" class="outline-4">
<h4 id="org5864f55"><span class="section-number-4">10.2.2</span> 创建 wordpress 的相关资源</h4>
<div class="outline-text-4" id="text-10-2-2">
</div>
<ol class="org-ol">
<li><a id="org4e40812"></a>创建 service<br />
<div class="outline-text-5" id="text-10-2-2-1">
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #e7c547;">apiVersion</span>: v1
<span style="color: #e7c547;">kind</span>: Service
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">name</span>: wordpress
  <span style="color: #e7c547;">labels</span>:
    <span style="color: #e7c547;">app</span>: wordpress
<span style="color: #e7c547;">spec</span>:
  <span style="color: #e7c547;">ports</span>:
    - <span style="color: #e7c547;">port</span>: 8080
  <span style="color: #e7c547;">selector</span>:
    <span style="color: #e7c547;">app</span>: wordpress
    <span style="color: #e7c547;">tier</span>: frontend
  <span style="color: #e7c547;">type</span>: NodePort
</pre>
</div>
</div>
</li>
<li><a id="org12868ca"></a>创建 PV<br />
<div class="outline-text-5" id="text-10-2-2-2">
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #e7c547;">apiVersion</span>: v1
<span style="color: #e7c547;">kind</span>: PersistentVolume
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">name</span>: wordpress
<span style="color: #e7c547;">spec</span>:
  <span style="color: #e7c547;">capacity</span>:
    <span style="color: #e7c547;">storage</span>: 20Gi
  <span style="color: #e7c547;">storageClassName</span>: mysql
  <span style="color: #e7c547;">accessModes</span>:
  - ReadWriteOnce
  <span style="color: #e7c547;">persistentVolumeReclaimPolicy</span>: Retain
  <span style="color: #e7c547;">local</span>:
    <span style="color: #e7c547;">path</span>: /mnt/lab/wordpress
  <span style="color: #e7c547;">nodeAffinity</span>:
    <span style="color: #e7c547;">required</span>:
      <span style="color: #e7c547;">nodeSelectorTerms</span>:
      - <span style="color: #e7c547;">matchExpressions</span>:
        - <span style="color: #e7c547;">key</span>: kubernetes.io/hostname
          <span style="color: #e7c547;">operator</span>: In
          <span style="color: #e7c547;">values</span>:
          - vagrant
</pre>
</div>
</div>
</li>
<li><a id="orgd37a7b9"></a>创建 PVC<br />
<div class="outline-text-5" id="text-10-2-2-3">
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #e7c547;">apiVersion</span>: v1
<span style="color: #e7c547;">kind</span>: PersistentVolumeClaim
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">name</span>: wordpress-pvc
  <span style="color: #e7c547;">labels</span>:
    <span style="color: #e7c547;">app</span>: wordpress
<span style="color: #e7c547;">spec</span>:
  <span style="color: #e7c547;">storageClassName</span>: mysql
  <span style="color: #e7c547;">accessModes</span>:
    - ReadWriteOnce
  <span style="color: #e7c547;">resources</span>:
    <span style="color: #e7c547;">requests</span>:
      <span style="color: #e7c547;">storage</span>: 20Gi
</pre>
</div>
</div>
</li>
<li><a id="org65c7d81"></a>创建 wordpress 的 deployment<br />
<div class="outline-text-5" id="text-10-2-2-4">
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #e7c547;">apiVersion</span>: apps/v1 <span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">for versions before 1.9.0 use apps/v1beta2</span>
<span style="color: #e7c547;">kind</span>: Deployment
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">name</span>: wordpress
  <span style="color: #e7c547;">labels</span>:
    <span style="color: #e7c547;">app</span>: wordpress
<span style="color: #e7c547;">spec</span>:
  <span style="color: #e7c547;">selector</span>:
    <span style="color: #e7c547;">matchLabels</span>:
      <span style="color: #e7c547;">app</span>: wordpress
      <span style="color: #e7c547;">tier</span>: frontend
  <span style="color: #e7c547;">strategy</span>:
    <span style="color: #e7c547;">type</span>: Recreate
  <span style="color: #e7c547;">template</span>:
    <span style="color: #e7c547;">metadata</span>:
      <span style="color: #e7c547;">labels</span>:
        <span style="color: #e7c547;">app</span>: wordpress
        <span style="color: #e7c547;">tier</span>: frontend
    <span style="color: #e7c547;">spec</span>:
      <span style="color: #e7c547;">containers</span>:
      - <span style="color: #e7c547;">image</span>: wordpress:4.8-apache
        <span style="color: #e7c547;">name</span>: wordpress
        <span style="color: #e7c547;">env</span>:
        - <span style="color: #e7c547;">name</span>: WORDPRESS_DB_HOST
          <span style="color: #e7c547;">value</span>: wordpress-mysql
        - <span style="color: #e7c547;">name</span>: WORDPRESS_DB_PASSWORD
          <span style="color: #e7c547;">value</span>: thisisapassword
        <span style="color: #e7c547;">ports</span>:
        - <span style="color: #e7c547;">containerPort</span>: 80
          <span style="color: #e7c547;">name</span>: wordpress
        <span style="color: #e7c547;">volumeMounts</span>:
        - <span style="color: #e7c547;">name</span>: wordpress-persistent-storage
          <span style="color: #e7c547;">mountPath</span>: /var/www/html
      <span style="color: #e7c547;">volumes</span>:
      - <span style="color: #e7c547;">name</span>: wordpress-persistent-storage
        <span style="color: #e7c547;">persistentVolumeClaim</span>:
          <span style="color: #e7c547;">claimName</span>: wordpress-mysql-pvc
</pre>
</div>
</div>
</li>
</ol>
</div>
<div id="outline-container-org471b45a" class="outline-4">
<h4 id="org471b45a"><span class="section-number-4">10.2.3</span> 注意事项</h4>
<div class="outline-text-4" id="text-10-2-3">
<p>
1.创建 PV 时保证 nodeaffinity 中的 values 是主机名
2.上面共有 5 处错误
</p>
</div>
</div>
</div>
<div id="outline-container-orgf6f0786" class="outline-3">
<h3 id="orgf6f0786"><span class="section-number-3">10.3</span> 创建一个最小的 Operator</h3>
<div class="outline-text-3" id="text-10-3">
</div>
<div id="outline-container-org8abc4f2" class="outline-4">
<h4 id="org8abc4f2"><span class="section-number-4">10.3.1</span> CustomResource 与 Operator</h4>
<div class="outline-text-4" id="text-10-3-1">
<p>
自定义资源是 k8s API 的扩展，通过自定义资源可以使用 k8s api 来控制自己的服务
</p>

<p>
Operator 最早是 coreOS 提出的一种模式，通过代码的方式来简单的运维服务
</p>
</div>

<ol class="org-ol">
<li><a id="org0673f51"></a>为什么 Operator 离不开 CustomResource<br />
<div class="outline-text-5" id="text-10-3-1-1">
<p>
Operators are software extensions to Kubernetes that make use of custom resources to manage applications and their components.
</p>

<p>
CustomResource 是 Operator 用来与 k8s 沟通的桥梁
</p>
</div>
</li>
</ol>
</div>

<div id="outline-container-org3e69f4d" class="outline-4">
<h4 id="org3e69f4d"><span class="section-number-4">10.3.2</span> 如何实现一个自定义的资源</h4>
<div class="outline-text-4" id="text-10-3-2">
<p>
实现一个自定义的资源有两种方式
</p>
</div>
<ol class="org-ol">
<li><a id="orgbe60fa8"></a>CRD<br />
<div class="outline-text-5" id="text-10-3-2-1">
<p>
下方是通过 yaml 创建的 CRD
</p>
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #e7c547;">apiVersion</span>: apiextensions.k8s.io/v1
<span style="color: #e7c547;">kind</span>: CustomResourceDefinition
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">name must match the spec fields below, and be in the form: &lt;plural&gt;.&lt;group&gt;</span>
  <span style="color: #e7c547;">name</span>: milvuses.zilliz.com
<span style="color: #e7c547;">spec</span>:
  <span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">group name to use for REST API: /apis/&lt;group&gt;/&lt;version&gt;</span>
  <span style="color: #e7c547;">group</span>: zilliz.com
  <span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">list of versions supported by this CustomResourceDefinition</span>
  <span style="color: #e7c547;">versions</span>:
    - <span style="color: #e7c547;">name</span>: v1
      <span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">Each version can be enabled/disabled by Served flag.</span>
      <span style="color: #e7c547;">served</span>: <span style="color: #7aa6da;">true</span>
      <span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">One and only one version must be marked as the storage version.</span>
      <span style="color: #e7c547;">storage</span>: <span style="color: #7aa6da;">true</span>
      <span style="color: #e7c547;">schema</span>:
        <span style="color: #e7c547;">openAPIV3Schema</span>:
          <span style="color: #e7c547;">type</span>: object
          <span style="color: #e7c547;">properties</span>:
            <span style="color: #e7c547;">spec</span>:
              <span style="color: #e7c547;">type</span>: object
              <span style="color: #e7c547;">properties</span>:
                <span style="color: #e7c547;">milvusSpec</span>:
                  <span style="color: #e7c547;">type</span>: string
                <span style="color: #e7c547;">image</span>:
                  <span style="color: #e7c547;">type</span>: string
                <span style="color: #e7c547;">replicas</span>:
                  <span style="color: #e7c547;">type</span>: integer
  <span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">either Namespaced or Cluster</span>
  <span style="color: #e7c547;">scope</span>: Namespaced
  <span style="color: #e7c547;">names</span>:
    <span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">plural name to be used in the URL: /apis/&lt;group&gt;/&lt;version&gt;/&lt;plural&gt;</span>
    <span style="color: #e7c547;">plural</span>: milvuses
    <span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">singular name to be used as an alias on the CLI and for display</span>
    <span style="color: #e7c547;">singular</span>: milvus
    <span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">kind is normally the CamelCased singular type. Your resource manifests use this.</span>
    <span style="color: #e7c547;">kind</span>: Milvus
    <span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">shortNames allow shorter string to match your resource on the CLI</span>
    <span style="color: #e7c547;">shortNames</span>:
    - mi

</pre>
</div>
</div>
</li>
<li><a id="org7ce7391"></a>AA (Aggregated API)<br />
<div class="outline-text-5" id="text-10-3-2-2">
<p>
CRD 是将资源注册到 k8s 当中，AA 则是将自定义的资源放到自己实现的 API Server 中
</p>

<p>
AA 必须使用 go 开发，并且提供相应的镜像
</p>

<p>
AA 可以提供更丰富的功能，可以看作独立实现的 API 服务，提供更丰富的功能：如改变存储方式、提供更多命令的支持、不同的协议
</p>
</div>
</li>
</ol>
</div>
<div id="outline-container-org197ee60" class="outline-4">
<h4 id="org197ee60"><span class="section-number-4">10.3.3</span> 在集群中创建一个 milvus</h4>
<div class="outline-text-4" id="text-10-3-3">
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #e7c547;">apiVersion</span>: <span style="color: #70c0b1;">"zilliz.com/v1"</span>
<span style="color: #e7c547;">kind</span>: Milvus
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">name</span>: milvus-crd-test
<span style="color: #e7c547;">spec</span>:
  <span style="color: #e7c547;">milvusSpec</span>: <span style="color: #70c0b1;">"this is milvus spec"</span>
  <span style="color: #e7c547;">image</span>: milvusdb/milvus
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd1a1a8c" class="outline-4">
<h4 id="orgd1a1a8c"><span class="section-number-4">10.3.4</span> 如何实现一个 Operator</h4>
<div class="outline-text-4" id="text-10-3-4">
<p>
在实现一个 operator 之前先想一个问题，这个 operator 的功能，这一次我们要做的是最简单的一个功能
</p>

<p>
当创建了一个 milvus 资源的时候，在默认的 namespace 下启动一个 milvus 实例
</p>

<p>
实现一个 Operator 有两种方式
</p>

<ol class="org-ol">
<li>使用框架如 kubebuilder operator-framework</li>

<li>使用 dynamicClient 写一个</li>
</ol>

<p>
先说为什么有两种方式:
由于 k8s 官方钦点的 go-client 中如果想要识别自定义资源，有两种方式：
1.按照格式来生成一堆代码与结构，并将资源注册到 apiserver。这种方式需要生成很多代码,现有的框架也都是为了这种模式服务的
2.使用 dynamicClient 可以最快速度的调试代码,因为 dynamicClient 本质上是对 k8s REST client 的封装
</p>

<p>
关于 kubebuilder 框架之类的内容会在之后讲到，这里来讲如何实现一个最小的 operator 详细代码可以参考 <a href="https://github.com/41tair/milvus-operator-example">https://github.com/41tair/milvus-operator-example</a>
</p>

<p>
1.从 k8s 集群中获取到 CR 的信息
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #b9ca4a;">func</span> <span style="color: #e78c45;">milvusGVR</span><span style="color: #eaeaea;">()</span> <span style="color: #7aa6da;">schema.GroupVersionResource</span><span style="color: #eaeaea;">{</span>
        <span style="color: #b9ca4a;">return</span> <span style="color: #7aa6da;">schema.GroupVersionResource</span><span style="color: #70c0b1;">{</span>
                <span style="color: #7aa6da;">Group</span>: <span style="color: #70c0b1;">"zilliz.com"</span>,
                <span style="color: #7aa6da;">Version</span>: <span style="color: #70c0b1;">"v1"</span>,
                <span style="color: #7aa6da;">Resource</span>: <span style="color: #70c0b1;">"milvuses"</span>,
        <span style="color: #70c0b1;">}</span>
<span style="color: #eaeaea;">}</span>

<span style="color: #b9ca4a;">func</span> <span style="color: #e78c45;">milvusList</span><span style="color: #eaeaea;">(</span><span style="color: #e7c547;">client</span> <span style="color: #7aa6da;">dynamic.Interface</span><span style="color: #eaeaea;">)</span> <span style="color: #eaeaea;">[]</span><span style="color: #7aa6da;">unstructured.Unstructured</span><span style="color: #eaeaea;">{</span>
        <span style="color: #e7c547;">milvusInstances</span>, <span style="color: #e7c547;">_</span> := client.<span style="color: #e78c45;">Resource</span><span style="color: #70c0b1;">(</span><span style="color: #e78c45;">milvusGVR</span><span style="color: #e7c547;">()</span><span style="color: #70c0b1;">)</span>.<span style="color: #e78c45;">Namespace</span><span style="color: #70c0b1;">(</span><span style="color: #70c0b1;">"default"</span><span style="color: #70c0b1;">)</span>.<span style="color: #e78c45;">List</span><span style="color: #70c0b1;">(</span>context.<span style="color: #e78c45;">TODO</span><span style="color: #e7c547;">()</span>, <span style="color: #7aa6da;">metav1.ListOptions</span><span style="color: #e7c547;">{}</span><span style="color: #70c0b1;">)</span>
        <span style="color: #b9ca4a;">return</span> milvusInstances.Items
<span style="color: #eaeaea;">}</span>

</pre>
</div>
<p>
2.从 k8s 集群中获取到当前的 pod
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #b9ca4a;">func</span> <span style="color: #e78c45;">milvusPods</span><span style="color: #eaeaea;">(</span><span style="color: #e7c547;">client</span> *<span style="color: #7aa6da;">kubernetes.Clientset</span><span style="color: #eaeaea;">)</span> <span style="color: #eaeaea;">[]</span><span style="color: #7aa6da;">v1.Pod</span><span style="color: #eaeaea;">{</span>
        <span style="color: #e7c547;">pods</span>, <span style="color: #e7c547;">_</span> := client.<span style="color: #e78c45;">CoreV1</span><span style="color: #70c0b1;">()</span>.<span style="color: #e78c45;">Pods</span><span style="color: #70c0b1;">(</span><span style="color: #70c0b1;">"default"</span><span style="color: #70c0b1;">)</span>.<span style="color: #e78c45;">List</span><span style="color: #70c0b1;">(</span>context.<span style="color: #e78c45;">TODO</span><span style="color: #e7c547;">()</span>, <span style="color: #7aa6da;">metav1.ListOptions</span><span style="color: #e7c547;">{}</span><span style="color: #70c0b1;">)</span>
        <span style="color: #b9ca4a;">return</span> pods.Items
<span style="color: #eaeaea;">}</span>

</pre>
</div>

<p>
3.在启动时开启循环定时进行比对并创建没有被创建的 pod
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #b9ca4a;">func</span> <span style="color: #e78c45;">mainLoop</span><span style="color: #eaeaea;">(</span><span style="color: #e7c547;">clientset</span> *<span style="color: #7aa6da;">kubernetes.Clientset</span>, <span style="color: #e7c547;">milvusList</span> <span style="color: #70c0b1;">[]</span><span style="color: #7aa6da;">unstructured.Unstructured</span>, <span style="color: #e7c547;">pods</span> <span style="color: #70c0b1;">[]</span><span style="color: #7aa6da;">v1.Pod</span><span style="color: #eaeaea;">)</span> <span style="color: #eaeaea;">{</span>
        <span style="color: #b9ca4a;">var</span> <span style="color: #e7c547;">waitForCreate</span> <span style="color: #70c0b1;">[]</span><span style="color: #7aa6da;">MilvusIns</span>
        <span style="color: #b9ca4a;">for</span> <span style="color: #e7c547;">_</span>, <span style="color: #e7c547;">milvus</span> := <span style="color: #b9ca4a;">range</span> milvusList <span style="color: #70c0b1;">{</span>
                <span style="color: #e7c547;">name</span> := milvus.Object<span style="color: #e7c547;">[</span><span style="color: #70c0b1;">"metadata"</span><span style="color: #e7c547;">]</span>.<span style="color: #e7c547;">(</span><span style="color: #b9ca4a;">map</span><span style="color: #b9ca4a;">[</span><span style="color: #7aa6da;">string</span><span style="color: #b9ca4a;">]</span><span style="color: #b9ca4a;">interface</span><span style="color: #b9ca4a;">{}</span><span style="color: #e7c547;">)[</span><span style="color: #70c0b1;">"name"</span><span style="color: #e7c547;">]</span>.<span style="color: #e7c547;">(</span><span style="color: #7aa6da;">string</span><span style="color: #e7c547;">)</span>
                <span style="color: #e7c547;">image</span> := milvus.Object<span style="color: #e7c547;">[</span><span style="color: #70c0b1;">"spec"</span><span style="color: #e7c547;">]</span>.<span style="color: #e7c547;">(</span><span style="color: #b9ca4a;">map</span><span style="color: #b9ca4a;">[</span><span style="color: #7aa6da;">string</span><span style="color: #b9ca4a;">]</span><span style="color: #b9ca4a;">interface</span><span style="color: #b9ca4a;">{}</span><span style="color: #e7c547;">)[</span><span style="color: #70c0b1;">"image"</span><span style="color: #e7c547;">]</span>.<span style="color: #e7c547;">(</span><span style="color: #7aa6da;">string</span><span style="color: #e7c547;">)</span>
                <span style="color: #b9ca4a;">if</span> <span style="color: #e78c45;">existInPods</span><span style="color: #e7c547;">(</span>name, pods<span style="color: #e7c547;">)</span> != <span style="color: #7aa6da;">true</span> <span style="color: #e7c547;">{</span>
                        waitForCreate = <span style="color: #c397d8;">append</span><span style="color: #b9ca4a;">(</span>waitForCreate, <span style="color: #7aa6da;">MilvusIns</span><span style="color: #7aa6da;">{</span>
                                <span style="color: #7aa6da;">Name</span>: name,
                                <span style="color: #7aa6da;">Image</span>: image,
                        <span style="color: #7aa6da;">}</span><span style="color: #b9ca4a;">)</span>
                <span style="color: #e7c547;">}</span>
        <span style="color: #70c0b1;">}</span>
        <span style="color: #b9ca4a;">for</span> <span style="color: #e7c547;">_</span>, <span style="color: #e7c547;">m</span> := <span style="color: #b9ca4a;">range</span> waitForCreate <span style="color: #70c0b1;">{</span>
                <span style="color: #e78c45;">createMilvusPod</span><span style="color: #e7c547;">(</span>clientset, m.Name, m.Image<span style="color: #e7c547;">)</span>
        <span style="color: #70c0b1;">}</span>

<span style="color: #eaeaea;">}</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">
<a href="http://man7.org/linux/man-pages/man7/cgroups.7.html">http://man7.org/linux/man-pages/man7/cgroups.7.html</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2">2</a></sup> <div class="footpara"><p class="footpara">
<a href="http://man7.org/linux/man-pages/man7/namespaces.7.html">http://man7.org/linux/man-pages/man7/namespaces.7.html</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.3" class="footnum" href="#fnr.3">3</a></sup> <div class="footpara"><p class="footpara">
<a href="http://man7.org/linux/man-pages/man2/chroot.2.html">http://man7.org/linux/man-pages/man2/chroot.2.html</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.4" class="footnum" href="#fnr.4">4</a></sup> <div class="footpara"><p class="footpara">
<a href="http://man7.org/linux/man-pages/man1/init.1.html">http://man7.org/linux/man-pages/man1/init.1.html</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.5" class="footnum" href="#fnr.5">5</a></sup> <div class="footpara"><p class="footpara">
<a href="https://github.com/opencontainers">https://github.com/opencontainers</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.6" class="footnum" href="#fnr.6">6</a></sup> <div class="footpara"><p class="footpara">
<a href="https://github.com/kubernetes/kubernetes/blob/242a97307b34076d5d8f5bbeb154fa4d97c9ef1d/pkg/kubelet/api/v1alpha1/runtime/api.proto">https://github.com/kubernetes/kubernetes/blob/242a97307b34076d5d8f5bbeb154fa4d97c9ef1d/pkg/kubelet/api/v1alpha1/runtime/api.proto</a>
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<p class="author">Author: Byron Wang</p>
<p class="date">Created: 2020-08-02 Sun 23:20</p>
<p class="validation"></p>
</div>
</body>
</html>
